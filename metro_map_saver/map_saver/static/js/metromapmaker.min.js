var lastStrokeStyle,gridRows=80,gridCols=80,activeTool="look",activeToolOption=!1,activeMap=!1,preferredGridPixelMultiplier=20,redrawOverlappingPoints={},dragX=!1,dragY=!1,clickX=!1,clickY=!1,hoverX=!1,hoverY=!1,temporaryStation={},temporaryLabel={},pngUrl=!1,mapHistory=[],mapRedoHistory=[],MAX_UNDO_HISTORY=100,currentlyClickingAndDragging=!1,mapLineWidth=1,mapLineStyle="solid",activeLineWidth=mapLineWidth,activeLineStyle=mapLineStyle,activeLineWidthStyle=mapLineWidth+"-"+mapLineStyle,mapStationStyle="wmata",menuIsCollapsed=!1,mapSize=void 0,rulerStep=5,MMMDEBUG=!0,MMMDEBUG_UNDO=!1;if(void 0===mapDataVersion)var mapDataVersion=void 0;function compatibilityModeIndicator(){1==mapDataVersion?($(".M:not(.mobile)").css({"background-color":"#bd1038"}),$("#title").css({color:"#bd1038"}),$("#tool-move-v1-warning").attr("style","")):2==mapDataVersion?($(".M:not(.mobile)").css({"background-color":"#df8600"}),$("#title").css({color:"#df8600"}),$("#tool-move-v1-warning").attr("style","display: none")):($(".M:not(.mobile)").css({"background-color":"#000"}),$("#title").css({color:"#000"}),$("#tool-move-v1-warning").attr("style","display: none"))}compatibilityModeIndicator();const numberKeys=["Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0"],ALLOWED_ORIENTATIONS=[0,45,-45,90,-90,135,-135,180,1,-1],ALLOWED_STYLES=["wmata","rect","rect-round","circles-lg","circles-md","circles-sm","circles-thin"],ALLOWED_SIZES=[80,120,160,200,240,360],MAX_MAP_SIZE=ALLOWED_SIZES[ALLOWED_SIZES.length-1];function resizeGrid(e){if(e=parseInt(e),gridRows=e,gridCols=e,3==mapDataVersion)for(var t in activeMap.points_by_color)for(var i in activeMap.points_by_color[t]){for(var a=e;a<MAX_MAP_SIZE;a++)activeMap.points_by_color[t][i][a]&&delete activeMap.points_by_color[t][i][a],activeMap.stations&&activeMap.stations[a]&&delete activeMap.stations[a];for(a=0;a<e;a++)for(var o=0;o<MAX_MAP_SIZE;o++)o>=e&&activeMap.points_by_color[t][i][a]&&activeMap.points_by_color[t][i][a][o]&&delete activeMap.points_by_color[t][i][a][o],o>=e&&activeMap.stations&&activeMap.stations[a]&&activeMap.stations[a][o]&&delete activeMap.stations[a][o]}else if(2==mapDataVersion)for(var t in activeMap.points_by_color){for(a=e;a<MAX_MAP_SIZE;a++)activeMap.points_by_color[t].xys[a]&&delete activeMap.points_by_color[t].xys[a],activeMap.stations&&activeMap.stations[a]&&delete activeMap.stations[a];for(a=0;a<e;a++)for(o=0;o<MAX_MAP_SIZE;o++)o>=e&&activeMap.points_by_color[t].xys[a]&&activeMap.points_by_color[t].xys[a][o]&&delete activeMap.points_by_color[t].xys[a][o],o>=e&&activeMap.stations&&activeMap.stations[a]&&activeMap.stations[a][o]&&delete activeMap.stations[a][o]}else if(1==mapDataVersion){for(a=e;a<MAX_MAP_SIZE;a++)delete activeMap[a];for(a=0;a<e;a++)for(o=0;o<MAX_MAP_SIZE;o++)o>=e&&activeMap[a]&&activeMap[a][o]&&delete activeMap[a][o]}for(var t in snapCanvasToGrid(),drawGrid(),lastStrokeStyle=void 0,activeMap.points_by_color)createColorCanvasIfNeeded(t,!0);drawCanvas(activeMap)}function resizeCanvas(e){var t=$("#canvas-container").width();step=gridCols,"out"==e&&t>=800?t-=step:"in"==e&&t<=6400?t+=step:Number.isNaN(e)||(t=parseInt(e)),t<800&&(t=800),t>6400&&(t=6400),window.sessionStorage.setItem("zoomLevel",t),$("#canvas-container").width(t),$("#canvas-container").height(t)}function snapCanvasToGrid(){var e=3600,t=document.getElementById("metro-map-canvas"),i=document.getElementById("metro-map-stations-canvas"),a=document.getElementById("grid-canvas"),o=document.getElementById("hover-canvas");t.height/gridCols!=preferredGridPixelMultiplier&&(gridCols*preferredGridPixelMultiplier<=e?(t.height=gridCols*preferredGridPixelMultiplier,i.height=gridCols*preferredGridPixelMultiplier,a.height=gridCols*preferredGridPixelMultiplier,o.height=gridCols*preferredGridPixelMultiplier):(t.height=e,i.height=e,a.height=e,o.height=e),gridRows*preferredGridPixelMultiplier<=e?(t.width=gridRows*preferredGridPixelMultiplier,i.width=gridRows*preferredGridPixelMultiplier,a.width=gridRows*preferredGridPixelMultiplier,o.width=gridRows*preferredGridPixelMultiplier):(t.width=e,i.width=e,a.width=e,o.width=e)),$("#canvas-container").height($("#metro-map-canvas").height()),$("#canvas-container").width($("#metro-map-canvas").height())}function coordinateInColor(e,t,i,a,o){if(3==mapDataVersion){if(i.points_by_color[a]&&i.points_by_color[a][o]&&i.points_by_color[a][o][e]&&i.points_by_color[a][o][e][t])return!0}else if(2==mapDataVersion){if(i.points_by_color[a]&&i.points_by_color[a].xys&&i.points_by_color[a].xys[e]&&i.points_by_color[a].xys[e][t])return!0}else if(1==mapDataVersion)return a?getActiveLine(e,t,i)==a:getActiveLine(e,t,i);return!1}function getActiveLine(e,t,i,a){if(3==mapDataVersion&&i.global.lines){for(var o in i.points_by_color)for(var l in i.points_by_color[o])if(coordinateInColor(e,t,i,o,l))return a?[o,l]:o}else if(2==mapDataVersion&&i.global.lines){for(var o in i.points_by_color)if(coordinateInColor(e,t,i,o))return o}else{if(i&&i[e]&&i[e][t]&&i[e][t].line)return i[e][t].line;if(!i)return!1}}function getStation(e,t,i){return i&&(2==mapDataVersion||3==mapDataVersion)&&i.stations&&i.stations[e]?i.stations[e][t]:i&&i[e]&&i[e][t]&&i[e][t].station?i[e][t].station:!!i&&void 0}function getLabel(e,t,i){return i&&(2==mapDataVersion||3==mapDataVersion)&&i.labels&&i.labels[e]?i.labels[e][t]:!!i&&void 0}function moveLineStroke(e,t,i,a,o){e.moveTo(t*gridPixelMultiplier,i*gridPixelMultiplier),e.lineTo(a*gridPixelMultiplier,o*gridPixelMultiplier),singleton=!1}function determineDarkOrLightContrast(e){total=0,rgb=[...e.matchAll(/(\d+)/g)];for(var t=0;t<rgb.length;t++)total+=parseInt(rgb[t][0]);return total<381?"#ffffff":"#000000"}function bindRailLineEvents(){$(".rail-line").click((function(){activeTool="line",activeToolOption=$(this).css("background-color"),$("#tool-line").addClass("draw-rail-line"),activeToolOption&&$("#tool-line").css({"background-color":activeToolOption,color:determineDarkOrLightContrast(activeToolOption)}),$("#tool-flood-fill").prop("checked")?(floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap,mapDataVersion>=3),activeToolOption,!0),$("#tool-line-icon-pencil").hide(),$("#tool-line-icon-paint-bucket").show()):(drawNewHoverIndicator(),$("#tool-line-icon-pencil").show(),$("#tool-line-icon-paint-bucket").hide()),$("#tool-station-options").hide()}))}function makeLine(e,t,i){if(1==mapDataVersion)drawArea(e,t,activeMap,!0);else if(mapDataVersion>=2)var a=getActiveLine(e,t,activeMap);var o=rgb2hex(activeToolOption).slice(1,7);metroMap=updateMapObject(e,t,"line",o),i||autoSave(metroMap),mapDataVersion>=2?(a&&redrawCanvasForColor(a),redrawCanvasForColor(o)):1==mapDataVersion&&drawArea(e,t,activeMap)}function redrawCanvasForColor(e){var t=performance.now();drawCanvas(!1,!1,!0),drawColor(e);var i=document.getElementById("metro-map-canvas").getContext("2d",{alpha:!0});for(var e in activeMap.points_by_color){var a=createColorCanvasIfNeeded(e);i.drawImage(a,0,0)}drawCanvas(activeMap,!0);var o=performance.now();MMMDEBUG&&console.log("redrawCanvasForColor finished in "+(o-t)+"ms")}function makeStation(e,t){if(temporaryStation={},!getActiveLine(e,t,activeMap))return activeToolOption?$("#tool-station").removeClass("width-100"):($("#tool-station").addClass("active"),$("#tool-line").removeClass("width-100"),$("#tool-line").removeClass("active")),$("#tool-station-options").hide(),void drawCanvas(activeMap,!0);$("#station-name").val(""),$("#station-coordinates-x").val(e),$("#station-coordinates-y").val(t);$(".rail-line");if($("#tool-station").addClass("width-100"),getStation(e,t,activeMap)){if(getStation(e,t,activeMap).name){var i=getStation(e,t,activeMap).name.replaceAll("_"," ");$("#station-name").val(i),getStation(e,t,activeMap).transfer?$("#station-transfer").prop("checked",!0):$("#station-transfer").prop("checked",!1),document.getElementById("station-name-orientation").value=parseInt(getStation(e,t,activeMap).orientation),document.getElementById("station-style").value=getStation(e,t,activeMap).style||""}}else{temporaryStation={name:""},$("#station-transfer").prop("checked",!1);var a=window.localStorage.getItem("metroMapStationOrientation");a?(document.getElementById("station-name-orientation").value=a,$("#station-name-orientation").change()):document.getElementById("station-name-orientation").value=0,document.getElementById("station-style").value=""}getActiveLine(e,t,activeMap)&&(drawCanvas(activeMap,!0),drawIndicator(e,t),$("#tool-station-options").show()),$("#station-name").focus()}function makeLabel(e,t){temporaryLabel={},$("#tool-label-options").show(),$("#label-coordinates-x").val(e),$("#label-coordinates-y").val(t);var i=getLabel(e,t,activeMap);if(i)i.text&&$("#label-text").val(i.text.replaceAll("_"," ")),i.shape&&$("#label-shape").val(i.shape),i["text-color"]&&$("#label-text-color").val(i["text-color"]),i["bg-color"]?$("#label-bg-color").val(i["bg-color"]):($("#label-bg-color").hide(),$("#label-bg-color-transparent").prop("checked",!0));else{temporaryLabel={text:"",shape:"","text-color":"","bg-color":""},$("#label-text").val("");var a=window.localStorage.getItem("lastLabelShape");a&&(document.getElementById("label-shape").value=a,$("#label-shape").trigger("change"))}drawCanvas(activeMap,!0),drawLabelIndicator(e,t),$("#label-text").focus()}function bindGridSquareEvents(e){if($("#station-coordinates-x").val(""),$("#station-coordinates-y").val(""),e.isTrusted)t=getCanvasXY(e.pageX,e.pageY);else var t=getCanvasXY(dragX,dragY);var i=t[0],a=t[1];if(e.isTrusted){if(currentlyClickingAndDragging)return}else{if(i==clickX||a==clickY);else if(Math.abs(i-clickX)==Math.abs(a-clickY));else if($("#straight-line-assist").prop("checked"))return;currentlyClickingAndDragging=!0}if("line"==activeTool)if($("#tool-flood-fill").prop("checked")){var o=getActiveLine(i,a,activeMap),l=rgb2hex(activeToolOption).slice(1,7);floodFill(i,a,getActiveLine(i,a,activeMap,mapDataVersion>=3),l),autoSave(activeMap),mapDataVersion>=2?(drawColor(o),redrawCanvasForColor(l)):1==mapDataVersion&&drawCanvas(activeMap)}else makeLine(i,a);else if("eraser"==activeTool){var n=getActiveLine(i,a,activeMap);if(!n)return;if(getStation(i,a,activeMap)||getLabel(i,a,activeMap))var r=!0;else r=!1;if(getLabel(i,a,activeMap));else;n&&$("#tool-flood-fill").prop("checked")?(floodFill(i,a,getActiveLine(i,a,activeMap,mapDataVersion>=3),""),autoSave(activeMap),mapDataVersion>=2?redrawCanvasForColor(n):1==mapDataVersion&&drawCanvas(activeMap)):(metroMap=updateMapObject(i,a),autoSave(metroMap),mapDataVersion>=2?redrawCanvasForColor(n):1==mapDataVersion&&drawArea(i,a,metroMap,n,r))}else"station"==activeTool?makeStation(i,a):"label"==activeTool&&makeLabel(i,a)}function bindGridSquareMouseover(e){if(MMMDEBUG&&$("#title").text(["XY: "+getCanvasXY(e.pageX,e.pageY)]),xy=getCanvasXY(e.pageX,e.pageY),hoverX=xy[0],hoverY=xy[1],mouseIsDown||$("#tool-flood-fill").prop("checked")){if(!mouseIsDown&&(activeToolOption||"eraser"==activeTool)&&$("#tool-flood-fill").prop("checked")){if("line"==activeTool&&activeToolOption)indicatorColor=activeToolOption;else{if("line"!=activeTool&&"eraser"!=activeTool)return void drawHoverIndicator(e.pageX,e.pageY);indicatorColor="#ffffff"}floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap,mapDataVersion>=3),indicatorColor,!0)}}else drawHoverIndicator(e.pageX,e.pageY);!mouseIsDown||"line"!=activeTool&&"eraser"!=activeTool||(dragX=e.pageX,dragY=e.pageY,$("#canvas-container").click())}function bindGridSquareMouseup(e){"station"==activeTool&&"text"!=document.activeElement.type&&$("#station-name").focus(),clickX=!1,clickY=!1,mouseIsDown=!1,drawHoverIndicator(e.pageX,e.pageY)}function bindGridSquareMousedown(e){if(xy=getCanvasXY(e.pageX,e.pageY),clickX=xy[0],clickY=xy[1],$("#straight-line-assist").prop("checked")&&("line"==activeTool||"eraser"==activeTool))for(var t=0;t<gridRows;t++)for(var i=0;i<gridCols;i++)t!=clickX&&i!=clickY&&Math.abs(t-clickX)!=Math.abs(i-clickY)||drawHoverIndicator(t,i,"#2E71CC");mouseIsDown&&dragX||(mouseIsDown=!0,currentlyClickingAndDragging=!1)}function drawHoverIndicator(e,t,i,a){var o=document.getElementById("hover-canvas"),l=o.getContext("2d");if(i||(l.clearRect(0,0,o.width,o.height),xy=getCanvasXY(e,t),e=xy[0],t=xy[1]),l.globalAlpha=a||.5,"line"==activeTool&&activeToolOption&&rgb2hex(activeToolOption))var n="#"+rgb2hex(activeToolOption).slice(1,7);else if("eraser"!=activeTool||getActiveLine(e,t,activeMap)){if("eraser"==activeTool)n="#ffffff"}else var n="#000000";l.fillStyle=i||n||"#2ECC71";var r=o.width/gridCols;l.fillRect(e*r-r/2,t*r-r/2,r,r)}function drawNewHoverIndicator(){var e=document.getElementById("hover-canvas"),t=e.getContext("2d");t.save(),t.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),t.globalAlpha=.75,t.fillStyle=activeToolOption,t.globalCompositeOperation="source-in",t.fillRect(0,0,e.width,e.height),t.restore()}function drawGrid(){var e=document.getElementById("grid-canvas"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.globalAlpha=.5,gridPixelMultiplier=e.width/gridCols;for(var i=0;i<gridCols;i++){var a,o;if(rulerStep&&i%rulerStep==0){if(t.strokeStyle="#60AEFF",i>0)gridCols<=240?(o=gridPixelMultiplier/2,i<10?a=i*gridPixelMultiplier+gridPixelMultiplier/4+2:i<100?a=i*gridPixelMultiplier+gridPixelMultiplier/4:i>=100&&(a=i*gridPixelMultiplier+gridPixelMultiplier/4-4)):gridCols>240&&(o=gridPixelMultiplier/1.25,i<10?a=i*gridPixelMultiplier+gridPixelMultiplier/4:i<100?a=i*gridPixelMultiplier+gridPixelMultiplier/4-3:i<1e3&&(a=i*gridPixelMultiplier+gridPixelMultiplier/4-6)),t.fillText(i,a,o),t.fillText(i,a,e.height-gridPixelMultiplier/4)}else t.strokeStyle="#80CEFF";t.beginPath(),t.moveTo(i*gridPixelMultiplier+gridPixelMultiplier/2,0),t.lineTo(i*gridPixelMultiplier+gridPixelMultiplier/2,e.height),t.stroke(),t.closePath()}for(var l=0;l<gridRows;l++){if(rulerStep&&l%rulerStep==0){t.strokeStyle="#60AEFF",t.fillText(l,0,l*gridPixelMultiplier+gridPixelMultiplier/2+3);var n=t.measureText(l);l>0&&t.fillText(l,e.width-n.width-gridPixelMultiplier/4,l*gridPixelMultiplier+gridPixelMultiplier/2+3)}else t.strokeStyle="#80CEFF";t.beginPath(),t.moveTo(0,l*gridPixelMultiplier+gridPixelMultiplier/2),t.lineTo(e.width,l*gridPixelMultiplier+gridPixelMultiplier/2),t.stroke(),t.closePath()}rulerStep?$("#ruler-step").text(rulerStep):$("#ruler-step").text("off")}function getRedrawSection(e,t,i,a){redrawSection={};for(var o=-1*(a=parseInt(a));o<=a;o+=1)for(var l=-1*a;l<=a;l+=1)getActiveLine(e+o,t+l,i)&&(redrawSection.hasOwnProperty(e+o)||(redrawSection[e+o]={}),redrawSection[e+o][t+l]=!0);return redrawSection}function drawArea(e,t,i,a,o){var l=document.getElementById("metro-map-canvas"),n=l.getContext("2d",{alpha:!1});gridPixelMultiplier=l.width/gridCols,fontSize=gridPixelMultiplier;for(var e in e=parseInt(e),t=parseInt(t),n.lineWidth=gridPixelMultiplier*activeLineWidth,n.lineCap="round","eraser"==activeTool&&a&&drawPoint(n,e,t,i,a),redrawSection=getRedrawSection(e,t,i,1),redrawSection)for(var t in redrawSection[e])lastStrokeStyle=void 0,e=parseInt(e),t=parseInt(t),"line"==activeTool&&a?drawPoint(n,e,t,i,getActiveLine(e,t,i)):drawPoint(n,e,t,i);if(redrawSection&&!o){var r=(s=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0});for(var e in r.font="700 "+fontSize+"px sans-serif",redrawSection)for(var t in redrawSection[e])drawStation(r,e=parseInt(e),t=parseInt(t),i,!0),drawLabel(r,e,t,i)}else if(o){var s;if((r=(s=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0})).clearRect(0,0,s.width,s.height),r.font="700 "+fontSize+"px sans-serif",2==mapDataVersion||3==mapDataVersion){for(var e in i.stations)for(var t in i.stations[e])drawStation(r,e=parseInt(e),t=parseInt(t),i);for(var e in i.labels)for(var t in i.labels[e])drawLabel(r,e=parseInt(e),t=parseInt(t),i)}else if(1==mapDataVersion)for(var e in i)for(var t in i[e])e=parseInt(e),t=parseInt(t),Number.isInteger(e)&&Number.isInteger(t)&&drawStation(r,e,t,i)}}function drawColor(e){if(e){var t=createColorCanvasIfNeeded(e),i=t.getContext("2d",{alpha:!0});if(i.clearRect(0,0,t.width,t.height),3==mapDataVersion)for(var a in activeMap.points_by_color[e]){i.strokeStyle="#"+e;var o=a.split("-")[0]*gridPixelMultiplier,l=a.split("-")[1],n=(v=findLines(e,a)).lines,r=v.singletons;for(var s of n)i.beginPath(),i.lineWidth=o,setLineStyle(l,i),moveLineStroke(i,s[0],s[1],s[2],s[3]),i.stroke(),i.closePath();for(var c of r){var p=(g=c.split(","))[0],d=g[1];i.strokeStyle="#"+e,drawPoint(i,p,d,activeMap,!1,e,o,l)}}else if(2==mapDataVersion){i.strokeStyle="#"+e,i.lineWidth=activeMap.global.style.mapLineWidth*gridPixelMultiplier,i.lineCap="round";var v;n=(v=findLines(e)).lines,r=v.singletons;for(var s of n)i.beginPath(),moveLineStroke(i,s[0],s[1],s[2],s[3]),i.stroke(),i.closePath();for(var c of r){var g;p=(g=c.split(","))[0],d=g[1];i.strokeStyle="#"+e,drawPoint(i,p,d,activeMap,!1,e)}}}}function createColorCanvasIfNeeded(e,t){if(!(i=document.getElementById("metro-map-color-canvas-"+e))){var i,a=document.getElementById("metro-map-canvas"),o=document.getElementById("color-canvas-container");(i=document.createElement("canvas")).id="metro-map-color-canvas-"+e,i.classList="hidden",i.width=a.width,i.height=a.height,o.appendChild(i)}if(t){a=document.getElementById("metro-map-canvas");i.width=a.width,i.height=a.height}return i}function findLines(e,t){if(2!=mapDataVersion||t||(t="xys"),2!=mapDataVersion&&3!=mapDataVersion||activeMap&&activeMap.points_by_color&&activeMap.points_by_color[e]&&activeMap.points_by_color[e][t]){var i={E:new Set,S:new Set,NE:new Set,SE:new Set},a=[],o=new Set,l=new Set;for(var n of["E","S","NE","SE"])for(var r in activeMap.points_by_color[e][t])for(var s in activeMap.points_by_color[e][t][r]){var c=r+","+s;if(!i[n].has(c)){var p=findEndpointOfLine(r,s,activeMap.points_by_color[e][t],n);if(p)for(var d of(a.push([parseInt(r),parseInt(s),p.x1,p.y1]),l.add(c),l.add(p.x1+","+p.y1),p.between))l.add(d),i[n].add(d);else l.has(c)||o.add(c)}}if("function"==typeof o.difference)var v=o.difference(l);else{v=new Set;for(var g of o)l.has(g)||v.add(g)}return{lines:a,singletons:v}}}function findEndpointOfLine(e,t,i,a){var o=[e+","+t];directions={E:{dx:1,dy:0},S:{dx:0,dy:1},NE:{dx:1,dy:-1},SE:{dx:1,dy:1},SW:{dx:-1,dy:1}};var l=directions[a].dx,n=directions[a].dy,r=parseInt(e)+l,s=parseInt(t)+n;if(i&&i[e]&&i[e][t]&&i[r]&&i[r][s]){for(;i[r]&&i[r][s];){o.push(r+","+s);r=parseInt(r)+l,s=parseInt(s)+n}var c=o[o.length-1].split(",");return{between:o,x1:r=parseInt(c[0]),y1:s=parseInt(c[1])}}}function drawCanvas(e,t,i){if(t0=performance.now(),t);else{var a=(d=document.getElementById("metro-map-canvas")).getContext("2d",{alpha:!1});gridPixelMultiplier=Math.floor(d.width/gridCols);var o=gridPixelMultiplier;if(a.fillStyle="#ffffff",a.fillRect(0,0,d.width,d.height),i)return;if(e||(e=activeMap),activeMap=e,a.lineWidth=mapLineWidth*gridPixelMultiplier,a.lineCap="round",mapDataVersion>=2)for(var l in e.points_by_color){drawColor(l);var n=document.getElementById("metro-map-color-canvas-"+l);a.drawImage(n,0,0)}else if(1==mapDataVersion){for(var r in e)for(var s in e[r])r=parseInt(r),s=parseInt(s),Number.isInteger(r)&&Number.isInteger(s)&&drawPoint(a,r,s,e);for(var c=Object.keys(redrawOverlappingPoints).reverse(),p=0;p<c.length;p++){r=c[p];for(var s in redrawOverlappingPoints[r])drawPoint(a,r=parseInt(r),s=parseInt(s),e)}redrawOverlappingPoints={}}}var d;a=(d=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0});gridPixelMultiplier=Math.floor(d.width/gridCols);o=gridPixelMultiplier;if(a.font="700 "+o+"px sans-serif",a.clearRect(0,0,d.width,d.height),3==mapDataVersion||2==mapDataVersion){for(var r in e.stations)for(var s in e.stations[r])drawStation(a,r=parseInt(r),s=parseInt(s),e);for(var r in e.labels)for(var s in e.labels[r])drawLabel(a,r=parseInt(r),s=parseInt(s),e)}else if(1==mapDataVersion)for(var r in e)for(var s in e[r])r=parseInt(r),s=parseInt(s),Number.isInteger(r)&&Number.isInteger(s)&&drawStation(a,r,s,e);a.textAlign="start",a.font="700 "+o+"px sans-serif",a.fillStyle="#000000";var v="Created with MetroMapMaker.com",g=a.measureText(v).width;a.fillText(v,gridRows*gridPixelMultiplier-g,gridCols*gridPixelMultiplier-50);var m=document.getElementById("shareable-map-link");if(m&&(m=m.text).length>0&&"https://metromapmaker.com/"==m.slice(0,26)){var h="Remix this map! Go to "+m;g=a.measureText(h).width;a.fillText(h,gridRows*gridPixelMultiplier-g,gridCols*gridPixelMultiplier-25)}t1=performance.now(),MMMDEBUG&&console.log("drawCanvas finished in "+(t1-t0)+"ms")}function drawPoint(e,t,i,a,o,l,n,r){if(t=parseInt(t),i=parseInt(i),(l=l||getActiveLine(t,i,a))||"eraser"==activeTool){if(e.beginPath(),lastStrokeStyle&&lastStrokeStyle==l||(e.strokeStyle="#"+l,lastStrokeStyle=l),o?(e.strokeStyle="#ffffff",l=o):(e.lineWidth=gridPixelMultiplier*(n||activeLineWidth),setLineStyle(r||activeLineStyle,e)),singleton=!0,n&&r)var s=n+"-"+r;else s=activeLineWidthStyle;coordinateInColor(t+1,i+1,a,l,s)&&(moveLineStroke(e,t,i,t+1,i+1),redrawOverlappingPoints[t]||(redrawOverlappingPoints[t]={}),redrawOverlappingPoints[t][i]=!0),coordinateInColor(t-1,i-1,a,l,s)&&moveLineStroke(e,t,i,t-1,i-1),coordinateInColor(t+1,i-1,a,l,s)&&moveLineStroke(e,t,i,t+1,i-1),coordinateInColor(t-1,i+1,a,l,s)&&moveLineStroke(e,t,i,t-1,i+1),coordinateInColor(t+1,i,a,l,s)&&moveLineStroke(e,t,i,t+1,i),coordinateInColor(t-1,i,a,l,s)&&moveLineStroke(e,t,i,t-1,i),coordinateInColor(t,i+1,a,l,s)&&moveLineStroke(e,t,i,t,i+1),coordinateInColor(t,i-1,a,l,s)&&moveLineStroke(e,t,i,t,i-1);var c=getStation(t,i,a);singleton?(e.fillStyle=o?"#ffffff":"#"+l,"rect"==mapStationStyle||c&&"rect"==c.style?e.fillRect((t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,gridPixelMultiplier,gridPixelMultiplier):"circles-md"==mapStationStyle||c&&"circles-md"==c.style?(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.7*gridPixelMultiplier,0,2*Math.PI,!0),e.fill()):"circles-sm"==mapStationStyle||c&&"circles-sm"==c.style?(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.5*gridPixelMultiplier,0,2*Math.PI,!0),e.fill()):(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.9*gridPixelMultiplier,0,2*Math.PI,!0),e.fill())):e.stroke(),e.closePath()}}function drawStation(e,t,i,a,o){var l=getStation(t,i,a);if(l){var n=l.transfer,r=l.style||mapStationStyle,s=!1;if(r&&"wmata"!=r)if("circles-lg"==r){drawStyledStation_WMATA(e,t,i,a,n,"#"+getActiveLine(t,i,a))}else"circles-md"==r?drawCircleStation(e,t,i,a,n,.3,gridPixelMultiplier/2):"circles-sm"==r?drawCircleStation(e,t,i,a,n,.25,gridPixelMultiplier/4):"rect"==r?s=drawStyledStation_rectangles(e,t,i,a,n,0,0):"rect-round"!=r&&"circles-thin"!=r||(s=drawStyledStation_rectangles(e,t,i,a,n,0,0,20));else drawStyledStation_WMATA(e,t,i,a,n);o||drawStationName(e,t,i,a,n,s)}}function drawStationName(e,t,i,a,o,l){e.textAlign="start",e.fillStyle="#000000",e.save();var n=getStation(t,i,a),r=n.name.replaceAll("_"," "),s=parseInt(n.orientation),c=e.measureText(r).width;if(o)var p=1.5*gridPixelMultiplier;else if(l)p=gridPixelMultiplier;else p=.75*gridPixelMultiplier;var d=.25*gridPixelMultiplier;-45==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-45),e.fillText(r,p,d)):45==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*45),e.fillText(r,p,d)):-90==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-90),e.fillText(r,-1*c-p,d)):90==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-90),e.fillText(r,p,d)):135==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-45),e.fillText(r,-1*c-p,d)):-135==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*45),e.fillText(r,-1*c-p,d)):180==s?o?e.fillText(r,t*gridPixelMultiplier-1.5*gridPixelMultiplier-c,i*gridPixelMultiplier+gridPixelMultiplier/4):e.fillText(r,t*gridPixelMultiplier-gridPixelMultiplier-c,i*gridPixelMultiplier+gridPixelMultiplier/4):1==s?(e.textAlign="center",o?e.fillText(r,t*gridPixelMultiplier,(i-1.5)*gridPixelMultiplier):e.fillText(r,t*gridPixelMultiplier,(i-1)*gridPixelMultiplier)):-1==s?(e.textAlign="center",o?e.fillText(r,t*gridPixelMultiplier,(i+2.25)*gridPixelMultiplier):e.fillText(r,t*gridPixelMultiplier,(i+1.75)*gridPixelMultiplier)):o?e.fillText(r,t*gridPixelMultiplier+1.5*gridPixelMultiplier,i*gridPixelMultiplier+gridPixelMultiplier/4):e.fillText(r,t*gridPixelMultiplier+gridPixelMultiplier,i*gridPixelMultiplier+gridPixelMultiplier/4),e.restore()}function drawStyledStation_WMATA(e,t,i,a,o,l,n){l||(l="#000000"),n||(n="#ffffff"),o&&(drawCircleStation(e,t,i,a,o,1.2,0,l,0,!0),drawCircleStation(e,t,i,a,o,.9,0,n,0,!0)),drawCircleStation(e,t,i,a,o,.6,0,l,0,!0),drawCircleStation(e,t,i,a,o,.3,0,n,0,!0)}function drawCircleStation(e,t,i,a,o,l,n,r,s,c){o&&!r&&(r="#"+getActiveLine(t,i,a)),!s&&o&&mapLineWidth>=.5&&(s="#ffffff",n=gridPixelMultiplier/2),e.fillStyle=r||"#ffffff",e.beginPath(),e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,gridPixelMultiplier*l,0,2*Math.PI,!0),e.closePath(),c||(e.lineWidth=n,e.strokeStyle=s||"#"+getActiveLine(t,i,a),e.stroke()),e.fill()}function drawStyledStation_rectangles(e,t,i,a,o,l,n,r,s){var c=getActiveLine(t,i,a,!0);if(3==mapDataVersion)var p="#"+c[0],d=c[1].split("-")[0];else if(2==mapDataVersion)p="#"+c,d=mapLineWidth;else if(1==mapDataVersion)p="#"+c,d=1;var v=getLineDirection(t,i,a).direction,g=[],m=!1,h=getConnectedStations(t,i,a),u=getStation(t,i,a),f=gridPixelMultiplier,y=gridPixelMultiplier;if(d>=.5&&"singleton"!=v||"singleton"==v&&("rect-round"==mapStationStyle||u&&"rect-round"==u.style)?(e.strokeStyle="#000000",e.fillStyle="#ffffff"):(e.strokeStyle=p,e.fillStyle=p),!0===h)f=gridPixelMultiplier/2;else if(u&&h&&"singleton"!=h&&"conflicting"!=h)dx=h.x1-h.x0,dy=h.y1-h.y0,f=(Math.abs(dx)+1)*gridPixelMultiplier,y=(Math.abs(dy)+1)*gridPixelMultiplier,m=!0,dx>0&&0==dy?v="horizontal":0==dx&&dy>0?v="vertical":dx>0&&dy>0?(v="diagonal-ne",f=gridPixelMultiplier):dx>0&&dy<0&&(v="diagonal-ne",y=gridPixelMultiplier);else{if(!h&&!s)return;"singleton"==h&&("singleton"==v?(e.strokeStyle="#000000",d<.5&&("rect-round"==mapStationStyle||u&&"rect-round"==u.style)&&(e.fillStyle=p)):o||(f=gridPixelMultiplier/2))}function b(a,o){if(e.save(),e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(o),m&&f>y){var l=f/gridPixelMultiplier;f+=l<4?l*(gridPixelMultiplier/4):l*(gridPixelMultiplier/3)}else if(m&&y>f){l=y/gridPixelMultiplier;y+=l<4?l*(gridPixelMultiplier/4):l*(gridPixelMultiplier/3)}MMMDEBUG&&t==$("#station-coordinates-x").val()&&i==$("#station-coordinates-y").val()&&console.log(`stationSpan: ${l}, w1: ${f} h1: ${y}`),r?primitiveRoundRect(e,...a,f,y,r):(e.strokeRect(...a,f,y),e.fillRect(...a,f,y)),e.restore()}if(m&&!s&&(e.strokeStyle="#000000",e.fillStyle="#ffffff"),(!m||!u&&s)&&("rect-round"==mapStationStyle||u&&"rect-round"==u.style)&&(r=2),u&&"rect"==u.style&&(r=!1),e.lineWidth=o?gridPixelMultiplier/2:gridPixelMultiplier/4,s&&!1===h&&(f>y&&(f=y),m=!0),"conflicting"==h&&(v="singleton",f>y&&(f=y),m=!1),l&&(e.strokeStyle=l),n&&(e.fillStyle=n),MMMDEBUG&&t==$("#station-coordinates-x").val()&&i==$("#station-coordinates-y").val()&&console.log(`xy: ${t},${i}; wh: ${f},${y} xf: ${o} ld: ${v} ra: ${g} cs: ${h} dac: ${m} sC: ${l} fC: ${n}`),!m&&("circles-thin"==mapStationStyle&&u&&!u.style||u&&"circles-thin"==u.style))return s||(l="#000000",n="#ffffff"),void drawCircleStation(e,t,i,activeMap,o,.5,e.lineWidth,n,l);if("singleton"==v||!u&&s&&("horizontal"==v||"vertical"==v))g=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,f,y];else if("horizontal"==v&&(m||o))g=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,f,y];else if("horizontal"!=v||m)if("vertical"==v&&(m||o))g=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,f,y];else if("vertical"!=v||m){if("diagonal-ne"==v&&(m||o))return void b([-.5*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/-4);if("diagonal-ne"==v&&!m)return void b([-.25*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/-4);if("diagonal-se"==v&&(m||o))return void b([-.5*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/4);if("diagonal-se"==v&&!m)return void b([-.25*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/4)}else g=[(t-.5)*gridPixelMultiplier,(i-.25)*gridPixelMultiplier,y,f];else g=[(t-.25)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,f,y];return r?primitiveRoundRect(e,...g,r):(e.strokeRect(...g),e.fillRect(...g)),m}function primitiveRoundRect(e,t,i,a,o,l){a<2*l&&(l=a/2),o<2*l&&(l=o/2),e.beginPath(),e.moveTo(t+l,i),e.arcTo(t+a,i,t+a,i+o,l),e.arcTo(t+a,i+o,t,i+o,l),e.arcTo(t,i+o,t,i,l),e.arcTo(t,i,t+a,i,l),e.stroke(),e.fill(),e.closePath()}function drawIndicator(e,t){var i=document.getElementById("metro-map-stations-canvas"),a=i.getContext("2d",{alpha:!1}),o=i.width/gridCols;if(getActiveLine(e,t,activeMap)){var l=getStation(e,t,activeMap),n=mapStationStyle;temporaryStation.style?n=temporaryStation.style:l&&l.style&&(n=l.style);var r=temporaryStation.transfer||l&&l.transfer;n&&"wmata"!=n&&"circles-lg"!=n?"circles-md"==n?drawCircleStation(a,e,t,activeMap,r,.3,o/2,"#00ff00","#000000"):"circles-sm"==n?drawCircleStation(a,e,t,activeMap,r,.25,o/4,"#00ff00","#000000"):"rect"==n?drawStyledStation_rectangles(a,e,t,activeMap,r,"#000000","#00ff00",!1,!0):"rect-round"!=n&&"circles-thin"!=n||drawStyledStation_rectangles(a,e,t,activeMap,r,"#000000","#00ff00",20,!0):drawStyledStation_WMATA(a,e,t,activeMap,r,"#000000","#00ff00")}}function drawLabel(e,t,i,a,o){var l=getLabel(t,i,a);if(l||o){o&&!l&&(l={text:"Label",shape:$("#label-shape").val(),"text-color":"#333333"});var n,r,s=e.measureText(l.text).width;n=s<gridPixelMultiplier?getWidthToNearestGrid(1.25*gridPixelMultiplier):getWidthToNearestGrid(parseInt(1.33*s));var c,p,d=gridPixelMultiplier;if((l["bg-color"]||o)&&(o?(e.fillStyle=o,e.strokeStyle=o):(e.fillStyle=l["bg-color"],e.strokeStyle=l["bg-color"]),"rect"==l.shape?(r=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,n,d],e.strokeRect(...r),e.fillRect(...r)):"rect-round"==l.shape?(r=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,n,d],primitiveRoundRect(e,...r,2)):"circle"==l.shape?(r=[t*gridPixelMultiplier,i*gridPixelMultiplier,gridPixelMultiplier,0,2*Math.PI],e.beginPath(),e.arc(...r),e.closePath(),e.stroke(),e.fill()):"square"==l.shape&&(r=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,gridPixelMultiplier,gridPixelMultiplier],e.strokeRect(...r),e.fillRect(...r))),l.text)e.font="700 "+gridPixelMultiplier+"px Helvetica,sans-serif",e.fillStyle=l["text-color"],c=t*gridPixelMultiplier,"circle"==l.shape||"square"==l.shape?(p=gridPixelMultiplier,e.textAlign="center"):"oval"==l.shape?e.textAlign="center":e.textAlign="start",e.fillText(l.text,c,i*gridPixelMultiplier+parseInt(gridPixelMultiplier/3),p)}}function drawLabelIndicator(e,t){var i=document.getElementById("metro-map-stations-canvas"),a=i.getContext("2d",{alpha:!1});i.width;drawLabel(a,e,t,activeMap,"#00ff00")}function getWidthToNearestGrid(e){return e%gridPixelMultiplier>0?Math.floor(e/gridPixelMultiplier)*gridPixelMultiplier+gridPixelMultiplier:Math.floor(e/gridPixelMultiplier)*gridPixelMultiplier}function rgb2hex(e){if(/^#[0-9A-F]{6}$/i.test(e))return e;function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+t((e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))[1])+t(e[2])+t(e[3])}function saveMapHistory(e){mapHistory.length>MAX_UNDO_HISTORY&&mapHistory.shift(),JSON.stringify(e)!=window.localStorage.getItem("metroMap")&&(mapHistory.push(JSON.stringify(e)),$("span#undo-buffer-count").text("("+mapHistory.length+")"),$("#tool-undo").prop("disabled",!1)),debugUndoRedo()}function autoSave(e){"object"==typeof e&&(saveMapHistory(activeMap=e),e=JSON.stringify(e)),window.localStorage.setItem("metroMap",e),mapRedoHistory=[],$("#tool-redo").prop("disabled",!0),$("span#redo-buffer-count").text(""),menuIsCollapsed||($("#autosave-indicator").text("Saving locally ..."),$("#title").hide(),setTimeout((function(){$("#autosave-indicator").text(""),$("#title").show()}),1500))}function loadMapFromUndoRedo(e){e&&(window.localStorage.setItem("metroMap",e),$(".rail-line").remove(),loadMapFromObject(e=JSON.parse(e)),setMapSize(e),drawCanvas(e),e.global&&e.global.style?(mapLineWidth=e.global.style.mapLineWidth||mapLineWidth||1,mapStationStyle=e.global.style.mapStationStyle||mapStationStyle||"wmata"):(mapLineWidth=1,mapStationStyle="wmata"),resetResizeButtons(gridCols),resetRailLineTooltips())}function undo(){var e=!1;if(mapHistory.length>1){var t=mapHistory.pop();e=mapHistory[mapHistory.length-1],$("span#undo-buffer-count").text("("+mapHistory.length+")")}else 1==mapHistory.length&&(e=mapHistory[0],$("span#undo-buffer-count").text(""),$("#tool-redo").prop("disabled",!0));mapRedoHistory.length>MAX_UNDO_HISTORY&&mapRedoHistory.shift(),(t||e)!=mapRedoHistory[mapRedoHistory.length-1]&&(mapRedoHistory.push(t||e),$("#tool-redo").prop("disabled",!1),$("span#redo-buffer-count").text("("+mapRedoHistory.length+")"),debugUndoRedo(),loadMapFromUndoRedo(e))}function redo(){var e=!1;mapRedoHistory.length>=1&&(e=mapRedoHistory.pop(),mapHistory.push(e)),$("span#undo-buffer-count").text("("+mapHistory.length+")"),e?(0==mapRedoHistory.length?$("span#redo-buffer-count").text(""):$("span#redo-buffer-count").text("("+mapRedoHistory.length+")"),loadMapFromUndoRedo(e)):$("span#redo-buffer-count").text("")}function debugUndoRedo(){if(MMMDEBUG&&MMMDEBUG_UNDO){$("#announcement").html("");for(var e=0;e<mapHistory.length;e++){var t=e+": "+JSON.stringify(mapHistory[e]).length;0==e?t+=" [OLDEST]":e==mapHistory.length-1&&(t+=" [NEWEST]"),$("#announcement").append("<p>"+t+"</p>")}}}function getURLParameter(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null}function autoLoad(){if(rulerStep=parseInt(window.localStorage.getItem("metroMapRulerStep")||rulerStep)||!1,"undefined"!=typeof savedMapData)activeMap=savedMapData;else{if(!window.localStorage.getItem("metroMap"))return $.get("/load/2LVHmJ3r").done((function(e){activeMap=e,"[ERROR]"==e.replace(/\s/g,"").slice(0,7)?(drawGrid(),bindRailLineEvents(),drawCanvas()):(setMapStyle(activeMap=JSON.parse(activeMap)),mapDataVersion=activeMap&&activeMap.global&&activeMap.global.data_version?activeMap.global.data_version:1,compatibilityModeIndicator(),mapSize=setMapSize(activeMap,mapDataVersion>1),loadMapFromObject(activeMap),mapHistory.push(JSON.stringify(activeMap)),setTimeout((function(){$("#tool-resize-"+gridRows).text("Initial size ("+gridRows+"x"+gridCols+")")}),1e3))})).fail((function(e){drawGrid(),bindRailLineEvents(),drawCanvas()})),void("undefined"!=typeof autoLoadError&&(autoLoadError+="Loading the default map.",$("#announcement").append('<h4 id="autoLoadError" class="bg-warning" style="text-align: left;">'+autoLoadError+"</h4>"),setTimeout((function(){$("#autoLoadError").remove()}),3e3)));activeMap=JSON.parse(window.localStorage.getItem("metroMap")),"undefined"!=typeof autoLoadError&&(autoLoadError+="Loading your last-edited map.")}setMapStyle(activeMap),mapDataVersion=activeMap&&activeMap.global&&activeMap.global.data_version?activeMap.global.data_version:1;var e=parseInt(getURLParameter("mapDataVersion"));if(MMMDEBUG&&e>=mapDataVersion)upgradeMapDataVersion(e);else try{upgradeMapDataVersion()}catch(e){console.warn("Error when trying to upgradeMapDataVersion(): "+e)}compatibilityModeIndicator(),mapSize=setMapSize(activeMap,mapDataVersion>1),loadMapFromObject(activeMap),mapHistory.push(JSON.stringify(activeMap)),"undefined"!=typeof autoLoadError&&($("#announcement").append('<h4 id="autoLoadError" class="bg-warning" style="text-align: left;">'+autoLoadError+"</h4>"),setTimeout((function(){$("#autoLoadError").remove()}),3e3)),setTimeout((function(){$("#tool-resize-"+gridRows).text("Initial size ("+gridRows+"x"+gridCols+")")}),1e3);var t=window.sessionStorage.getItem("zoomLevel");t&&resizeCanvas(t)}function getMapSize(e){var t=0;if("object"!=typeof e&&(e=JSON.parse(e)),3==mapDataVersion)for(var i in e.points_by_color)for(var a in e.points_by_color[i]){for(var o in thisColorHighestValue=Math.max(...Object.keys(e.points_by_color[i][a]).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e.points_by_color[i][a][t]).length>0}))),e.points_by_color[i][a]){if(thisColorHighestValue>=ALLOWED_SIZES[ALLOWED_SIZES.length-2]){t=thisColorHighestValue;break}y=Math.max(...Object.keys(e.points_by_color[i][a][o]).map(Number).filter(Number.isInteger)),y>thisColorHighestValue&&(thisColorHighestValue=y)}thisColorHighestValue>t&&(t=thisColorHighestValue)}else if(2==mapDataVersion)for(var i in e.points_by_color){for(var o in thisColorHighestValue=Math.max(...Object.keys(e.points_by_color[i].xys).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e.points_by_color[i].xys[t]).length>0}))),e.points_by_color[i].xys){if(thisColorHighestValue>=ALLOWED_SIZES[ALLOWED_SIZES.length-2]){t=thisColorHighestValue;break}y=Math.max(...Object.keys(e.points_by_color[i].xys[o]).map(Number).filter(Number.isInteger)),y>thisColorHighestValue&&(thisColorHighestValue=y)}thisColorHighestValue>t&&(t=thisColorHighestValue)}else if(1==mapDataVersion)for(var o in t=Math.max(...Object.keys(e).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e[t]).length>0}))),e){if(t>=ALLOWED_SIZES[ALLOWED_SIZES.length-2])break;y=Math.max(...Object.keys(e[o]).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e[o][t]).length>0}))),y>t&&(t=y)}return t}function setMapSize(e,t){var i=gridRows;if(t)gridRows=e.global.map_size,gridCols=e.global.map_size;else for(allowedSize of(highestValue=getMapSize(e),ALLOWED_SIZES))if(highestValue<allowedSize){gridRows=allowedSize,gridCols=allowedSize,e.global.map_size=gridRows;break}resizeGrid(gridRows),gridRows!=i&&($("#canvas-container").width(Math.round($("#canvas-container").width()/gridCols)*gridCols),$("#canvas-container").height(Math.round($("#canvas-container").width()/gridRows)*gridRows))}function setMapStyle(e){e.global&&e.global.style&&(mapLineWidth=e.global.style.mapLineWidth||mapLineWidth,mapStationStyle=e.global.style.mapStationStyle||mapStationStyle)}function isMapStretchable(e){return e?e<=MAX_MAP_SIZE/2:gridRows<=MAX_MAP_SIZE/2&&gridCols<=MAX_MAP_SIZE/2}function loadMapFromObject(e,t){if("object"!=typeof e&&(e=JSON.parse(e)),!t){drawGrid(),Object.keys(e.global.lines).length>0?$("#tool-line-options button.original-rail-line").remove():e.global.lines={bd1038:{displayName:"Red Line"},df8600:{displayName:"Orange Line"},f0ce15:{displayName:"Yellow Line"},"00b251":{displayName:"Green Line"},"0896d7":{displayName:"Blue Line"},"662c90":{displayName:"Purple Line"},a2a2a2:{displayName:"Silver Line"},"000000":{displayName:"Logo"},"79bde9":{displayName:"Rivers"},cfe4a7:{displayName:"Parks"}};var i=1;for(var a in e.global.lines)e.global.lines.hasOwnProperty(a)&&null===document.getElementById("rail-line-"+a)&&(keyboardShortcut=i<11?' data-toggle="tooltip" title="Keyboard shortcut: '+numberKeys[i-1].replace("Digit","")+'"':i<21?' data-toggle="tooltip" title="Keyboard shortcut: Shift + '+numberKeys[i-1].replace("Digit","")+'"':i<31?' data-toggle="tooltip" title="Keyboard shortcut: Alt + '+numberKeys[i-1].replace("Digit","")+'"':"",$("#line-color-options fieldset").append('<button id="rail-line-'+a+'" class="rail-line has-tooltip" style="background-color: #'+a+';"'+keyboardShortcut+">"+e.global.lines[a].displayName+"</button>"),i++);$((function(){$('[data-toggle="tooltip"]').tooltip({container:"body"}),bindRailLineEvents(),resetRailLineTooltips(),$(".visible-xs").is(":visible")&&($("#canvas-container").removeClass("hidden-xs"),$("#tool-export-canvas").click(),$("#try-on-mobile").attr("disabled",!1))}))}}function updateMapObject(e,t,i,a){if(activeMap)var o=activeMap;else o=JSON.parse(window.localStorage.getItem("metroMap"));if(3==mapDataVersion&&"line"==activeTool?(o.points_by_color[a]||(o.points_by_color[a]={}),o.points_by_color[a][activeLineWidthStyle]||(o.points_by_color[a][activeLineWidthStyle]={})):2==mapDataVersion&&"line"==activeTool&&(o.points_by_color[a]&&o.points_by_color[a].xys||(o.points_by_color[a]={xys:{}})),"eraser"==activeTool){if(3==mapDataVersion){for(var l in a||(a=getActiveLine(e,t,o)),o.points_by_color[a])o.points_by_color&&o.points_by_color[a]&&o.points_by_color[a][l]&&o.points_by_color[a][l][e]&&o.points_by_color[a][l][e][t]&&delete o.points_by_color[a][l][e][t];o.stations&&o.stations[e]&&o.stations[e][t]&&delete o.stations[e][t],o.labels&&o.labels[e]&&o.labels[e][t]&&delete o.labels[e][t]}else 2==mapDataVersion?(a||(a=getActiveLine(e,t,o)),o.points_by_color&&o.points_by_color[a]&&o.points_by_color[a].xys&&o.points_by_color[a].xys[e]&&o.points_by_color[a].xys[e][t]&&delete o.points_by_color[a].xys[e][t],o.stations&&o.stations[e]&&o.stations[e][t]&&delete o.stations[e][t],o.labels&&o.labels[e]&&o.labels[e][t]&&delete o.labels[e][t]):1==mapDataVersion&&o[e]&&o[e][t]&&delete o[e][t];return o}if(1==mapDataVersion&&(o.hasOwnProperty(e)?o[e].hasOwnProperty(t)||(o[e][t]={}):(o[e]={},o[e][t]={})),3==mapDataVersion&&"line"==activeTool)for(var n in o.points_by_color[a][activeLineWidthStyle][e]||(o.points_by_color[a][activeLineWidthStyle][e]={}),o.points_by_color[a][activeLineWidthStyle][e][t]=1,o.points_by_color)for(var l in o.points_by_color[n])n==a&&l==activeLineWidthStyle||o.points_by_color[n][l]&&o.points_by_color[n][l][e]&&o.points_by_color[n][l][e][t]&&delete o.points_by_color[n][l][e][t];else if(2==mapDataVersion&&"line"==activeTool)for(var n in o.points_by_color[a].xys[e]||(o.points_by_color[a].xys[e]={}),o.points_by_color[a].xys[e][t]=1,o.points_by_color)n!=a&&o.points_by_color[n].xys&&o.points_by_color[n].xys[e]&&o.points_by_color[n].xys[e][t]&&delete o.points_by_color[n].xys[e][t];else 1==mapDataVersion&&"line"==activeTool?o[e][t].line=a:"station"==activeTool?2==mapDataVersion||3==mapDataVersion?(o.stations||(o.stations={}),o.stations[e]||(o.stations[e]={}),o.stations[e][t]||(o.stations[e][t]={}),o.stations[e][t][i]=a):o[e][t].station[i]=a:"label"==activeTool&&(2!=mapDataVersion&&3!=mapDataVersion||(o.labels||(o.labels={}),o.labels[e]||(o.labels[e]={}),o.labels[e][t]||(o.labels[e][t]={}),i?o.labels[e][t][i]=a:o.labels[e][t]=a));return o}function moveMap(e){if("station"!=activeTool||!$("#tool-station-options").is(":visible")){var t=0,i=0;if("left"==e)t=-1;else if("right"==e)t=1;else if("down"==e)i=1;else if("up"==e)i=-1;if(3==mapDataVersion){var a={},o={};for(var l in activeMap.points_by_color)for(var n in a[l]={},activeMap.points_by_color[l])for(var r in a[l][n]={},activeMap.points_by_color[l][n])for(var s in activeMap.points_by_color[l][n][r])if(r=parseInt(r),s=parseInt(s),Number.isInteger(r)&&Number.isInteger(s)){if(a[l][n][r+t]||(a[l][n][r+t]={}),0==r&&"left"==e)return;if(r==gridCols-1&&"right"==e)return;if(0==s&&"up"==e)return;if(s==gridRows-1&&"down"==e)return;0<=r&&r<gridCols&&0<=s&&s<gridCols&&0<=r+t&&r+t<gridCols&&0<=s+i&&s+i<gridCols&&(a[l][n][r+t][s+i]=activeMap.points_by_color[l][n][r][s],activeMap.stations&&activeMap.stations[r]&&activeMap.stations[r][s]&&(o[r+t]||(o[r+t]={}),o[r+t][s+i]=activeMap.stations[r][s]))}activeMap.points_by_color=a,activeMap.stations=o}else if(2==mapDataVersion){a={},o={};for(var l in activeMap.points_by_color)for(var r in a[l]={xys:{}},activeMap.points_by_color[l].xys)for(var s in activeMap.points_by_color[l].xys[r])if(r=parseInt(r),s=parseInt(s),Number.isInteger(r)&&Number.isInteger(s)){if(a[l].xys[r+t]||(a[l].xys[r+t]={}),0==r&&"left"==e)return;if(r==gridCols-1&&"right"==e)return;if(0==s&&"up"==e)return;if(s==gridRows-1&&"down"==e)return;0<=r&&r<gridCols&&0<=s&&s<gridCols&&0<=r+t&&r+t<gridCols&&0<=s+i&&s+i<gridCols&&(a[l].xys[r+t][s+i]=activeMap.points_by_color[l].xys[r][s],activeMap.stations&&activeMap.stations[r]&&activeMap.stations[r][s]&&(o[r+t]||(o[r+t]={}),o[r+t][s+i]=activeMap.stations[r][s]))}activeMap.points_by_color=a,activeMap.stations=o}else if(1==mapDataVersion){for(var r in newMapObject={},activeMap)for(var s in activeMap[r])r=parseInt(r),s=parseInt(s),Number.isInteger(r)&&Number.isInteger(s)&&(newMapObject[r+t]||(newMapObject[r+t]={}),0<=r&&r<gridCols&&0<=s&&s<gridCols&&0<=r+t&&r+t<gridCols&&0<=s+i&&s+i<gridCols&&(newMapObject[r+t][s+i]=activeMap[r][s]));newMapObject.global=activeMap.global,activeMap=newMapObject}return drawCanvas(activeMap),autoSave(activeMap),!0}}function disableRightClick(e){e.preventDefault()}function enableRightClick(){document.getElementById("grid-canvas").removeEventListener("contextmenu",disableRightClick),document.getElementById("hover-canvas").removeEventListener("contextmenu",disableRightClick)}function getCanvasXY(e,t){var i=$("#canvas-container"),a=i.width(),o=i.height(),l=parseInt($("#main-container").css("padding-left")),n=parseInt($("#main-container").css("margin-top"))+parseInt($("#mobile-header").height());e=parseInt(e)-l,t=parseInt(t)-n;var r=Math.round(e/a*gridCols),s=Math.round(t/o*gridRows);return r<0?r=0:r>=gridCols&&(r=gridCols-1),s<0?s=0:s>=gridRows&&(s=gridRows-1),[r,s]}function floodFill(e,t,i,a,o){if(mapDataVersion>=3&&i){var l=i[1];i=i[0]}else l=!1;if(!(i==a&&mapDataVersion>=3&&l==activeLineWidthStyle)&&!(i==a&&mapDataVersion<3)&&e&&t){var n=!1,r=spanBelow=0,s=[e,t],c={};if(o){var p=document.getElementById("hover-canvas");p.getContext("2d").clearRect(0,0,p.width,p.height)}for(;s.length>0;){for(t=s.pop(),n=e=s.pop();n>=0&&(!getActiveLine(e,t,activeMap)&&!getActiveLine(n,t,activeMap)||coordinateInColor(n,t,activeMap,i,l));)n--;for(n++,r=spanBelow=0;n<gridCols&&(!i&&!getActiveLine(n,t,activeMap)||coordinateInColor(n,t,activeMap,i,l));){if(o){if(c&&c[n]&&c[n][t])break;c.hasOwnProperty(n)||(c[n]={}),drawHoverIndicator(n,t,a,.5),c[n][t]=!0}else updateMapObject(n,t,"line",a);!r&&t>0&&(!i&&!getActiveLine(n,t-1,activeMap)||coordinateInColor(n,t-1,activeMap,i,l))?(s.push(n,t-1),r=1):r&&t>0&&(!i&&!getActiveLine(n,t-1,activeMap)||!coordinateInColor(n,t-1,activeMap,i,l))&&(r=0),!spanBelow&&t<gridRows-1&&(!i&&!getActiveLine(n,t+1,activeMap)||coordinateInColor(n,t+1,activeMap,i,l))?(s.push(n,t+1),spanBelow=1):spanBelow&&t<gridRows-1&&(!i&&!getActiveLine(n,t+1,activeMap)||!coordinateInColor(n,t+1,activeMap,i,l))&&(spanBelow=0),n++}}}}function combineCanvases(){drawCanvas(activeMap);var e=document.getElementById("metro-map-canvas"),t=document.getElementById("metro-map-stations-canvas");return e.getContext("2d",{alpha:!1}).drawImage(t,0,0),t.getContext("2d",{alpha:!0}).clearRect(0,0,t.width,t.height),e}function downloadImage(e,t){var i="metromapmaker.png";if(HTMLCanvasElement.prototype.toBlob)pngUrl&&URL.revokeObjectURL(pngUrl),e.toBlob((function(e){pngUrl=URL.createObjectURL(e),$("#metro-map-image-download-link").attr({download:i,href:pngUrl}),t?($("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide(),$("#metro-map-image").attr("src",pngUrl),$("#metro-map-image").show()):(document.getElementById("metro-map-image-download-link").click(),drawCanvas(activeMap))}));else{var a=e.toDataURL();$("#metro-map-image-download-link").attr({download:i,href:a}),t?($("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide(),$("#metro-map-image").attr("src",a),$("#metro-map-image").show()):(document.getElementById("metro-map-image-download-link").click(),drawCanvas(activeMap))}}function resetResizeButtons(e){$(".resize-grid").each((function(){if("Current"==$(this).html().split(" ")[0]){var e=$(this).attr("id").split("-").slice(2),t=e+"x"+e;$(this).text(t)}})),$("#tool-resize-"+e).text("Current size ("+e+"x"+e+")"),isMapStretchable(e)?($("#tool-resize-stretch").show(),$("#tool-resize-stretch").text("Stretch map to "+2*e+"x"+2*e)):$("#tool-resize-stretch").hide()}function throttle(e,t){let i=!0;return function(...a){i&&(i=!1,e.apply(this,a),setTimeout((()=>i=!0),t))}}function resetTooltipOrientation(){tooltipOrientation="",window.innerWidth<=768?tooltipOrientation="top":$("#snap-controls-right").is(":hidden")?tooltipOrientation="left":tooltipOrientation="right",$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement=tooltipOrientation)}))}function resetRailLineTooltips(){for(var e=$(".rail-line"),t="",i=0;i<e.length;i++){var a=$(".rail-line")[i].id.slice(10,16);t=i<10?"Keyboard shortcut: "+numberKeys[i].replace("Digit",""):i<20?"Keyboard shortcut: Shift + "+numberKeys[i].replace("Digit",""):i<30?"Keyboard shortcut: Alt + "+numberKeys[i].replace("Digit",""):"",$("#rail-line-"+a).attr("title",t).tooltip("fixTitle")}resetTooltipOrientation()}function showGrid(){$("canvas#grid-canvas").removeClass("hide-gridlines"),$("canvas#grid-canvas").css("opacity",1),$("#tool-grid span").html("<b><u>H</u></b>ide grid")}function hideGrid(){$("canvas#grid-canvas").addClass("hide-gridlines"),$("canvas#grid-canvas").css("opacity",0),$("#tool-grid span").html("S<b><u>h</u></b>ow grid")}function setFloodFillUI(){if($("#tool-flood-fill").prop("checked"))$("#tool-line-icon-pencil").hide(),$("#tool-line-caption-draw").hide(),$("#tool-line-icon-paint-bucket").show(),$("#tool-eraser-icon-paint-bucket").show(),$("#tool-eraser-icon-eraser").hide(),$("#tool-eraser-caption-eraser").hide(),menuIsCollapsed||($("#tool-line-caption-fill").show(),$("#tool-eraser-caption-fill").show()),("line"==activeTool&&activeToolOption||"eraser"==activeTool)&&(indicatorColor="line"==activeTool&&activeToolOption?activeToolOption:"#ffffff",floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap,mapDataVersion>=3),indicatorColor,!0));else{$("#tool-line-icon-pencil").show(),$("#tool-eraser-icon-eraser").show(),$("#tool-line-icon-paint-bucket").hide(),$("#tool-line-caption-fill").hide(),menuIsCollapsed||($("#tool-line-caption-draw").show(),$("#tool-eraser-caption-eraser").show()),$("#tool-eraser-icon-paint-bucket").hide(),$("#tool-eraser-caption-fill").hide(),$("#tool-eraser-options").hide();var e=document.getElementById("hover-canvas");e.getContext("2d").clearRect(0,0,e.width,e.height),("line"==activeTool&&activeToolOption||"eraser"==activeTool)&&(indicatorColor="line"==activeTool&&activeToolOption?activeToolOption:"#ffffff",drawHoverIndicator(hoverX,hoverY,indicatorColor))}}function setURLAfterSave(e){window.location.href.split("=")[0]}function getSurroundingLine(e,t,i,a){return getActiveLine((e=parseInt(e))-1,t=parseInt(t),i)&&getActiveLine(e-1,t,i)==getActiveLine(e+1,t,i)?getActiveLine(e-1,t,i,a):getActiveLine(e,t-1,i)&&getActiveLine(e,t-1,i)==getActiveLine(e,t+1,i)?getActiveLine(e,t-1,i,a):getActiveLine(e-1,t-1,i)&&getActiveLine(e-1,t-1,i)==getActiveLine(e+1,t+1,i)?getActiveLine(e-1,t-1,i,a):getActiveLine(e-1,t+1,i)&&getActiveLine(e-1,t+1,i)==getActiveLine(e+1,t-1,i)?getActiveLine(e-1,t+1,i,a):void 0}function setAllStationOrientations(e,t){if(t=parseInt(t),-1!=ALLOWED_ORIENTATIONS.indexOf(t))if(2==mapDataVersion||3==mapDataVersion)for(var i in e.stations)for(var a in e.stations[i])i=parseInt(i),a=parseInt(a),e.stations[i][a].orientation=t;else if(1==mapDataVersion)for(var i in e)for(var a in e[i])i=parseInt(i),a=parseInt(a),Number.isInteger(i)&&Number.isInteger(a)&&-1!=Object.keys(e[i][a]).indexOf("station")&&(e[i][a].station.orientation=t)}function resetAllStationStyles(e){if(2==mapDataVersion||3==mapDataVersion)for(var t in e.stations)for(var i in e.stations[t])t=parseInt(t),i=parseInt(i),e.stations[t][i].style&&delete e.stations[t][i].style;else if(1==mapDataVersion)for(var t in e)for(var i in e[t])t=parseInt(t),i=parseInt(i),Number.isInteger(t)&&Number.isInteger(i)&&-1!=Object.keys(e[t][i]).indexOf("station")&&-1!=Object.keys(e[t][i].station).indexOf("style")&&delete e[t][i].station.style}function combineLineColorWidthStyle(e){return"object"==typeof e?e.join("-"):e}function getLineDirection(e,t,i){return e=parseInt(e),t=parseInt(t),origin=combineLineColorWidthStyle(getActiveLine(e,t,i,mapDataVersion>=3)),NW=combineLineColorWidthStyle(getActiveLine(e-1,t-1,i,mapDataVersion>=3)),NE=combineLineColorWidthStyle(getActiveLine(e+1,t-1,i,mapDataVersion>=3)),SW=combineLineColorWidthStyle(getActiveLine(e-1,t+1,i,mapDataVersion>=3)),SE=combineLineColorWidthStyle(getActiveLine(e+1,t+1,i,mapDataVersion>=3)),N=combineLineColorWidthStyle(getActiveLine(e,t-1,i,mapDataVersion>=3)),E=combineLineColorWidthStyle(getActiveLine(e+1,t,i,mapDataVersion>=3)),S=combineLineColorWidthStyle(getActiveLine(e,t+1,i,mapDataVersion>=3)),W=combineLineColorWidthStyle(getActiveLine(e-1,t,i,mapDataVersion>=3)),info={direction:!1,endcap:!1},origin?(origin==W&&W==E?info.direction="horizontal":origin==N&&N==S?info.direction="vertical":origin==NW&&NW==SE?info.direction="diagonal-se":origin==SW&&SW==NE?info.direction="diagonal-ne":origin==W||origin==E?(info.direction="horizontal",info.endcap=!0):origin==N||origin==S?(info.direction="vertical",info.endcap=!0):origin==NW||origin==SE?(info.direction="diagonal-se",info.endcap=!0):origin==SW||origin==NE?(info.direction="diagonal-ne",info.endcap=!0):info.direction="singleton",info):info}function getConnectedStations(e,t,i){if(getStation(e=parseInt(e),t=parseInt(t),i)){var a=getStation(e-1,t-1,i),o=getStation(e+1,t-1,i),l=getStation(e-1,t+1,i),n=getStation(e+1,t+1,i),r=getStation(e,t-1,i),s=getStation(e+1,t,i),c=getStation(e,t+1,i),p=getStation(e-1,t,i);if(!(a||o||l||n||r||s||c||p))return"singleton";var d={highest:{E:0,S:0,SE:0,NE:0},E:{},S:{},N:{},W:{},NE:{},SE:{},SW:{},NW:{}};if(s&&f(s)){var v=e,g=t;do{v+=1}while(f(getStation(v,g,i)));d.E={x1:v-1,y1:g},d.highest.E=v-e-1}if(c&&f(c)){v=e,g=t;do{g+=1}while(f(getStation(v,g,i)));d.S={x1:v,y1:g-1},d.highest.S=g-t-1}if(o&&f(o)){v=e,g=t;do{v+=1,g-=1}while(f(getStation(v,g,i)));d.NE={x1:v-1,y1:g+1},d.highest.NE=v-e-1}if(n&&f(n)){v=e,g=t;do{v+=1,g+=1}while(f(getStation(v,g,i)));d.SE={x1:v-1,y1:g-1},d.highest.SE=v-e-1}if(p&&f(p)){v=e,g=t;do{v-=1}while(f(getStation(v,g,i)));d.W={x1:v+1,y1:g},d.E.internal=!0,d.highest.E+=Math.abs(v-e)-1}if(r&&f(r)){v=e,g=t;do{g-=1}while(f(getStation(v,g,i)));d.N={x1:v,y1:g+1},d.S.internal=!0,d.highest.S+=Math.abs(g-t)-1}if(a&&f(a)){v=e,g=t;do{v-=1,g-=1}while(f(getStation(v,g,i)));d.NW={x1:v+1,y1:g+1},d.SE.internal=!0,d.highest.SE+=Math.abs(v-e)-1}if(l&&f(l)){v=e,g=t;do{v-=1,g+=1}while(f(getStation(v,g,i)));d.SW={x1:v+1,y1:g-1},d.NE.internal=!0,d.highest.NE+=Math.abs(v-e)-1}var m=Object.values(d.highest).filter((e=>e>0)),h=Math.max(...Object.values(m));if(0==m.length)return"singleton";if(m.indexOf(h)!=m.lastIndexOf(h))return"conflicting";var u=Object.keys(d.highest).filter((e=>!0!==Number.isNaN(e))).sort((function(e,t){return d.highest[e]-d.highest[t]})).reverse();return!u||!u[0]||!d[u[0]].internal&&{x0:e,y0:t,x1:d[u[0]].x1,y1:d[u[0]].y1}}function f(e){return!!e&&("rect"==e.style||"rect-round"==e.style||"circles-thin"==e.style||!(e.style||"rect"!=mapStationStyle&&"rect-round"!=mapStationStyle&&"circles-thin"!=mapStationStyle))}}function stretchMap(e){e||(e=activeMap);var t={};if(t.global=Object.assign({},activeMap.global),3==mapDataVersion){for(var i in t.points_by_color={},e.points_by_color)for(var a in t.points_by_color[i]={},e.points_by_color[i])for(var o in t.points_by_color[i][a]={},e.points_by_color[i][a])for(var l in e.points_by_color[i][a][o])o=parseInt(o),l=parseInt(l),e.points_by_color[i][a][o][l]&&(2*o>MAX_MAP_SIZE-1||2*l>MAX_MAP_SIZE-1||(t.points_by_color[i][a].hasOwnProperty(2*o)||(t.points_by_color[i][a][2*o]={}),t.points_by_color[i][a][2*o][2*l]=e.points_by_color[i][a][o][l]));for(var o in setMapSize(t),resetResizeButtons(gridCols),t.stations={},e.stations)for(var l in e.stations[o])o=parseInt(o),l=parseInt(l),2*o>=gridRows||2*l>=gridCols||(t.stations.hasOwnProperty(2*o)||(t.stations[2*o]={}),t.stations[2*o][2*l]=Object.assign({},e.stations[o][l]));for(o=1;o<gridRows;o++)for(l=1;l<gridCols;l++){var n=getSurroundingLine(o,l,t,!0);if(n){i=n[0],a=n[1];t.points_by_color[i][a]||(t.points_by_color[i][a]={}),t.points_by_color[i][a].hasOwnProperty(o)||(t.points_by_color[i][a][o]={}),t.points_by_color[i][a][o][l]=1}}}else if(2==mapDataVersion){for(var i in t.points_by_color={},e.points_by_color)for(var o in t.points_by_color[i]={xys:{}},e.points_by_color[i].xys)for(var l in e.points_by_color[i].xys[o])o=parseInt(o),l=parseInt(l),e.points_by_color[i].xys[o][l]&&(2*o>MAX_MAP_SIZE-1||2*l>MAX_MAP_SIZE-1||(t.points_by_color[i].xys.hasOwnProperty(2*o)||(t.points_by_color[i].xys[2*o]={}),t.points_by_color[i].xys[2*o][2*l]=e.points_by_color[i].xys[o][l]));for(var o in setMapSize(t),resetResizeButtons(gridCols),t.stations={},e.stations)for(var l in e.stations[o])o=parseInt(o),l=parseInt(l),2*o>=gridRows||2*l>=gridCols||(t.stations.hasOwnProperty(2*o)||(t.stations[2*o]={}),t.stations[2*o][2*l]=Object.assign({},e.stations[o][l]));for(o=1;o<gridRows;o++)for(l=1;l<gridCols;l++){(i=getSurroundingLine(o,l,t))&&(t.points_by_color[i].xys.hasOwnProperty(o)||(t.points_by_color[i].xys[o]={}),t.points_by_color[i].xys[o][l]=1)}}else if(1==mapDataVersion){for(var o in e)for(var l in e[o])o=parseInt(o),l=parseInt(l),Number.isInteger(o)&&Number.isInteger(l)&&(t.hasOwnProperty(2*o)||(t[2*o]={}),t[2*o][2*l]=e[o][l]);setMapSize(t),resetResizeButtons(gridCols);for(o=1;o<gridRows;o++)for(l=1;l<gridCols;l++){var r=getSurroundingLine(o,l,t);r&&(t.hasOwnProperty(o)||(t[o]={}),t[o][l]={line:r})}}return autoSave(activeMap=t),loadMapFromObject(t),drawCanvas(t),t}function replaceColors(e,t){var i=JSON.stringify(activeMap);"object"==typeof e&&(e.name&&t.name&&(e.color&&$("#rail-line-"+e.color).text(t.name),i=i.replaceAll('"displayName":"'+e.name+'"','"displayName":"'+t.name+'"')),e.color&&t.color&&e.color.match("[a-fA-F0-9]{6}")&&t.color.match("[a-fA-F0-9]{6}")&&(i=i.replaceAll('"'+e.color+'"','"'+t.color+'"')),e.color!=t.color&&$("#rail-line-"+e.color).remove(),(i=JSON.parse(i)).global.lines[e.color]&&"object"==typeof t&&t.name&&(i.global.lines[e.color].displayName=t.name),loadMapFromObject(activeMap=i),drawCanvas(activeMap),autoSave(activeMap))}function editOnSmallScreen(){$("#mobile-header").removeClass("visible-xs"),$("#mobile-header").hide(),$("#mobile-header").css({height:0}),$("#controls").removeClass("hidden-xs"),collapseToolbox(),$("#snap-controls-left").trigger("click"),$("#tool-line").prop("disabled")&&$("#tool-export-canvas").click(),$("#grid-canvas").show(),$("#hover-canvas").show(),$("#metro-map-canvas").show(),$("#metro-map-stations-canvas").show(),$("#metro-map-image").hide(),$("#canvas-container").removeClass("hidden-xs"),snapCanvasToGrid(),drawGrid(),drawCanvas()}function collapseToolbox(){menuIsCollapsed||(menuIsCollapsed=!0,$("#controls").addClass("collapsed"),$("#toolbox button span.button-label").hide(),$("#title, #remix, #credits, #rail-line-new, #tool-new-line-options, #line-style-options, #rail-line-change, #tool-change-line-options, #rail-line-delete, #straight-line-assist-options, #flood-fill-options, #tool-move-all, #tool-move-options, #tool-resize-all, #tool-resize-options, #tool-map-style, #tool-map-style-options, #name-map, #name-this-map").hide(),$("#controls-collapse-menu").hide(),$("#tool-line-caption-draw").hide(),$("#tool-eraser-caption-eraser").hide(),$("#tool-line-caption-fill").hide(),$("#tool-eraser-caption-fill").hide(),1==$("#hide-save-share-url").length&&$("#hide-save-share-url").hide(),$("#rail-line-new").children("span").text("Add New Line"),$("#rail-line-change").children("span").html("Edit colors &amp; names"),$("#controls-expand-menu").show())}function expandToolbox(){if(menuIsCollapsed){menuIsCollapsed=!1,$("#controls").removeClass("collapsed");var e=$("#tool-line").attr("style");e&&$("#tool-line").attr("style",e),$("#controls").attr("style")&&$("#controls").attr("style").indexOf("left: 5px")>-1?$("#snap-controls-left").hide():$("#snap-controls-right").hide(),$("#toolbox button span.button-label").show(),$("#title, #remix, #credits, #rail-line-new, #line-style-options, #rail-line-change, #rail-line-delete, #straight-line-assist-options, #flood-fill-options, #tool-move-all, #tool-resize-all, #tool-map-style").show(),$("#tool-move-all, #tool-resize-all").removeClass("width-100"),$("#tool-flood-fill").prop("checked")?($("#tool-line-caption-draw").hide(),$("#tool-eraser-caption-eraser").hide()):($("#tool-line-caption-fill").hide(),$("#tool-eraser-caption-fill").hide()),1==$("#hide-save-share-url").length&&$("#hide-save-share-url").show(),"Name this map"==$("#name-this-map").text()&&$("#name-map, #name-this-map").show(),$("#controls-collapse-menu").show(),$("#controls-expand-menu").hide()}}function colorInUse(e){if(!activeMap||!activeMap.points_by_color||!activeMap.points_by_color[e])return!1;if(3==mapDataVersion){for(var t in activeMap.points_by_color[e])for(var i in activeMap.points_by_color[e][t])for(var a in activeMap.points_by_color[e][t][i])if(activeMap.points_by_color[e][t][i][a])return!0}else if(2==mapDataVersion){if(!activeMap.points_by_color[e].xys)return;for(var i in activeMap.points_by_color[e].xys)for(var a in activeMap.points_by_color[e].xys[i])if(activeMap.points_by_color[e].xys[i][a])return!0}}function setLineStyle(e,t){var i;"solid"==e?(i=[],t.lineCap="round"):"dashed"==e?(i=[gridPixelMultiplier,1.5*gridPixelMultiplier],t.lineCap="square"):"dotted_dense"==e?(t.lineCap="butt",i=[gridPixelMultiplier/2,gridPixelMultiplier/4]):"dotted"==e?(t.lineCap="butt",i=[gridPixelMultiplier/2,gridPixelMultiplier/2]):"dense_thick"==e?(i=[2,2],t.lineCap="butt"):"dense_thin"==e?(i=[1,1],t.lineCap="butt"):(i=[],t.lineCap="round"),t.setLineDash(i)}function unfreezeMapControls(){window.innerWidth>768&&$("#tool-line").prop("disabled")&&$("#tool-export-canvas").click(),resetTooltipOrientation()}function restyleAllLines(e,t){var i={points_by_color:{}};for(var a in i.stations=Object.assign({},activeMap.stations),i.global=Object.assign({},activeMap.global),activeMap.points_by_color)for(var o in activeMap.points_by_color[a]){if(mapDataVersion>=3)var l=o.split("-")[0],n=o.split("-")[1];var r=(e||l)+"-"+(t||n);i.points_by_color[a]||(i.points_by_color[a]={}),i.points_by_color[a][r]||(i.points_by_color[a][r]={}),i.points_by_color[a][r]=Object.assign(i.points_by_color[a][r],activeMap.points_by_color[a][o])}2==mapDataVersion&&(mapDataVersion=3,i.global.data_version=3,compatibilityModeIndicator()),autoSave(activeMap=i),drawCanvas(activeMap)}function upgradeMapDataVersion(e){if(1==mapDataVersion){if(e&&1==e)return $("#line-style-options").hide(),void $("#tool-map-style, #tool-map-style-options").hide();var t={points_by_color:{},stations:{}};for(var i in t.global=Object.assign({},activeMap.global),activeMap)for(var a in activeMap[i]){var o=activeMap[i][a].line;o&&(t.points_by_color[o]||(t.points_by_color[o]={xys:{}}),t.points_by_color[o].xys[i]||(t.points_by_color[o].xys[i]={}),t.points_by_color[o].xys[i][a]=1,activeMap[i][a].station&&(t.stations[i]||(t.stations[i]={}),t.stations[i][a]=Object.assign({},activeMap[i][a].station)))}mapDataVersion=2,t.global.data_version=2,activeMap=t,compatibilityModeIndicator()}if(2==mapDataVersion){if(e&&2==e)return void $("#line-style-options").hide();var l=1,n="solid";activeMap.global&&activeMap.global.style&&activeMap.global.style.mapLineWidth&&(l=activeMap.global.style.mapLineWidth),activeMap.global&&activeMap.global.style&&activeMap.global.style.mapLineStyle&&(n=activeMap.global.style.mapLineStyle),restyleAllLines(l,n)}mapHistory=[],mapRedoHistory=[]}String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)},autoLoad(),$(document).ready((function(){document.getElementById("canvas-container").addEventListener("click",bindGridSquareEvents,!1),document.getElementById("canvas-container").addEventListener("mousedown",bindGridSquareMousedown,!1),document.getElementById("canvas-container").addEventListener("mousemove",throttle(bindGridSquareMouseover,1),!1),document.getElementById("canvas-container").addEventListener("mouseup",bindGridSquareMouseup,!1),window.addEventListener("resize",unfreezeMapControls),window.addEventListener("scroll",(function(){$(".tooltip").hide()})),mouseIsDown=!1,document.getElementById("grid-canvas").addEventListener("contextmenu",disableRightClick),document.getElementById("hover-canvas").addEventListener("contextmenu",disableRightClick),$((function(){$('[data-toggle="tooltip"]').tooltip({container:"body"}),window.innerWidth<=768&&$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="top")}))})),document.addEventListener("keydown",(function(e){if(document.activeElement&&"text"==document.activeElement.type)"Enter"==e.key&&("new-rail-line-name"==document.activeElement.id?$("#create-new-rail-line").click():"change-line-name"==document.activeElement.id&&$("#save-rail-line-edits").click(),document.activeElement.blur());else{var t=$(".rail-line"),i=!1;"z"==e.key&&(e.metaKey||e.ctrlKey)&&undo(),"y"==e.key&&(e.metaKey||e.ctrlKey)?(e.preventDefault(),redo()):"c"!=e.key||e.metaKey||e.ctrlKey?"d"==e.key?$("#tool-line").trigger("click"):"e"==e.key?$("#tool-eraser").trigger("click"):"f"==e.key?($("#tool-flood-fill").prop("checked")?$("#tool-flood-fill").prop("checked",!1):$("#tool-flood-fill").prop("checked",!0),setFloodFillUI()):"g"==e.key?$("#straight-line-assist").prop("checked")?$("#straight-line-assist").prop("checked",!1):$("#straight-line-assist").prop("checked",!0):"h"==e.key?$("#tool-grid").trigger("click"):"s"==e.key?$("#tool-station").trigger("click"):"l"==e.key?$("#tool-label").trigger("click"):"y"!=e.key||e.metaKey||e.ctrlKey?"r"!=e.key||e.metaKey||e.altKey?"ArrowLeft"!=e.key||e.metaKey||e.altKey?"ArrowUp"==e.key?(e.preventDefault(),moveMap("up")):"ArrowRight"!=e.key||e.metaKey||e.altKey?"ArrowDown"==e.key?(e.preventDefault(),moveMap("down")):"-"==e.key||"_"==e.key?$("#tool-zoom-out").trigger("click"):"="==e.key||"+"==e.key?$("#tool-zoom-in").trigger("click"):"BracketLeft"==e.code?$("#snap-controls-left").trigger("click"):"BracketRight"==e.code?$("#snap-controls-right").trigger("click"):!e.metaKey&&!e.ctrlKey&&e.shiftKey&&numberKeys.indexOf(e.code)>=0?i=numberKeys.indexOf(e.code)+10:!e.metaKey&&!e.ctrlKey&&e.altKey&&numberKeys.indexOf(e.code)>=0?i=numberKeys.indexOf(e.code)+20:!e.metaKey&&!e.ctrlKey&&numberKeys.indexOf(e.code)>=0&&(i=numberKeys.indexOf(e.code)):(e.preventDefault(),moveMap("right")):(e.preventDefault(),moveMap("left")):$("#tool-ruler").trigger("click"):menuIsCollapsed||$("#tool-map-style").trigger("click"):menuIsCollapsed?$("#controls-expand-menu").trigger("click"):$("#controls-collapse-menu").trigger("click"),!1!==i&&t[i]&&t[i].click()}})),activeTool="look",$("#toolbox button:not(.rail-line)").on("click",(function(){$(".active").removeClass("active"),$(this).addClass("active"),"line"==activeTool?$("#tool-line").addClass("active"):"eraser"==activeTool?$("#tool-eraser").addClass("active"):"station"==activeTool&&$("#tool-station").addClass("active")})),$("#toolbox button.rail-line").on("click",(function(){$(".active").removeClass("active"),$("#tool-line").addClass("active")})),$("#tool-line").on("click",(function(){$(".active").removeClass("active"),$("#tool-line").addClass("active"),$(this).hasClass("draw-rail-line")&&activeToolOption?(activeTool="line",$(this).css({"background-color":activeToolOption})):"eraser"==activeTool&&activeToolOption?activeTool="line":"eraser"==activeTool&&(activeTool="look"),$("#tool-line-options").is(":visible")?($("#tool-line-options").hide(),$("#tool-new-line-options").hide(),$("#tool-station").hasClass("width-100")||$(this).removeClass("width-100"),$("#rail-line-new span").text("Add New Line"),$("#tool-new-line-options").hide()):($("#tool-line-options").show(),$(this).addClass("width-100")),$(".tooltip").hide()})),$("#tool-flood-fill").change((function(){setFloodFillUI()})),$("#rail-line-delete").click((function(){var e=$(".rail-line"),t=[],i=Object.assign({},activeMap);if("line"==activeTool&&(activeTool="look",$("#tool-line").attr("style",""),$("#tool-line").removeClass("active")),2==mapDataVersion||3==mapDataVersion)for(var a of e)colorInUse(a=a.id.slice(10,16))||(t.push($("#rail-line-"+a)),delete activeMap.global.lines[a]);else if(1==mapDataVersion){delete i.global,i=JSON.stringify(i);for(var o=0;o<e.length;o++)"rail-line-new"!=$(".rail-line")[o].id&&-1==i.indexOf('"line":"'+$(".rail-line")[o].id.slice(10,16)+'"')&&(t.push($("#"+$(".rail-line")[o].id)),delete activeMap.global.lines[$(".rail-line")[o].id.split("-").slice(2,3)])}if(t.length>0){autoSave(activeMap);for(var l=0;l<t.length;l++)t[l].remove();resetRailLineTooltips()}})),$("#tool-station").click((function(){activeTool="station",$(".active").removeClass("active"),$("#tool-station").addClass("active"),$("#tool-station-options").is(":visible")&&($("#tool-station-options").hide(),$(this).removeClass("width-100")),$(".tooltip").hide()})),$("#tool-label").on("click",(function(){activeTool="label",$(".active").removeClass("active"),$(this).addClass("active"),$("#tool-label-options").is(":visible")&&($("#tool-label-options").hide(),$(this).removeClass("width-100"))})),$("#tool-eraser").on("click",(function(){activeTool="eraser",$(".active").removeClass("active"),$("#tool-eraser").addClass("active"),$("#tool-station-options").hide(),$(".tooltip").hide(),$("#tool-line").attr("style",""),$("#tool-line-options").is(":visible")||$("#tool-line").removeClass("width-100"),$("#tool-station").attr("style",""),$("#tool-station-options").is(":visible")||$("#tool-station").removeClass("width-100"),setFloodFillUI()})),$("#tool-grid").click((function(){$("canvas#grid-canvas").hasClass("hide-gridlines")?showGrid():hideGrid(),$(".tooltip").hide()})),$("#tool-zoom-in").click((function(){resizeCanvas("in")})),$("#tool-zoom-out").click((function(){resizeCanvas("out")})),$("#snap-controls-left").click((function(){$("#controls").css("left",5),$("#controls").css("right","unset"),$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="right")})),$(this).hide(),$("#snap-controls-right").show()})),$("#snap-controls-right").click((function(){$("#controls").css("right",5),$("#controls").css("left","unset"),$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="left")})),$(this).hide(),$("#snap-controls-left").show()})),$("#tool-resize-all").click((function(){$("#tool-resize-options").is(":visible")?($("#tool-resize-options").hide(),$(this).removeClass("width-100"),$(this).removeClass("active")):($("#tool-resize-options").show(),$(this).addClass("width-100"),isMapStretchable()?($("#tool-resize-stretch").show(),$("#tool-resize-stretch").text("Stretch map to "+2*gridRows+"x"+2*gridCols)):$("#tool-resize-stretch").hide()),$(".tooltip").hide()})),$(".resize-grid").click((function(){autoSave(activeMap);var e=activeTool;activeTool="resize",size=$(this).attr("id").split("-").slice(2),resetResizeButtons(size),activeMap&&activeMap.global&&activeMap.global.map_size&&(activeMap.global.map_size=parseInt(size)),setMapSize(activeMap,!0),activeTool=e})),$("#tool-resize-stretch").click((function(){autoSave(activeMap),stretchMap()})),$("#tool-move-all").on("click",(function(){$("#tool-move-options").is(":visible")?($("#tool-move-options").hide(),$(this).removeClass("active"),$(this).removeClass("width-100")):($("#tool-move-options").show(),$(this).addClass("width-100")),$(".tooltip").hide()})),$("#tool-move-up").click((function(){moveMap("up")})),$("#tool-move-down").click((function(){moveMap("down")})),$("#tool-move-left").click((function(){moveMap("left")})),$("#tool-move-right").click((function(){moveMap("right")})),$("#tool-save-map").click((function(){activeTool="look";var e=JSON.stringify(activeMap);autoSave(e);csrftoken=getCookie("csrftoken"),$("#tool-save-map").prop("disabled","disabled"),$("#tool-save-map span").text("Saving ..."),setTimeout((function(){$("#tool-save-map").prop("disabled",!1)}),1e3),$.post("/save/",{metroMap:e,csrfmiddlewaretoken:csrftoken}).done((function(e){if(e.replace(/\n/g,"").indexOf("No points_by_color")>-1)$("#tool-save-options").html('<h5 class="bg-danger">You can\'t save an empty map.</h5>'),$("#tool-save-options").show();else if("[ERROR]"==e.replace(/\s/g,"").slice(0,7))$("#tool-save-options").html('<h5 class="bg-danger">Sorry, there was a problem saving your map: '+e.slice(9)+"</h5>"),console.log("[WARN] Problem was: "+e),$("#tool-save-options").show();else{menuIsCollapsed&&$("#controls-expand-menu").trigger("click");var t=(e=e.split(","))[0].replace(/\s/g,""),i=e[1].replace(/\s/g,""),a='<button id="hide-save-share-url" class="styling-greenline width-100">Hide sharing explanation</button><h5 style="overflow-x: hidden;" class="text-left">Map Saved! You can share your map with a friend by using this link: <a id="shareable-map-link" href="/map/'+t+'" target="_blank">metromapmaker.com/map/'+t+'</a></h5> <h5 class="text-left">You can then share this URL with a friend - and they can remix your map without you losing your original! <b>If you make changes to this map, click Save &amp; Share again to get a new URL.</b></h5>';i&&(a+='<form id="name-map" class="text-left"><input type="hidden" name="urlhash" value="'+t+'"><input id="naming-token" type="hidden" name="naming_token" value="'+i+'"><label for="name">Where is this a map of?</label><input id="user-given-map-name" type="text" name="name"><select id="user-given-map-tags" name="tags"><option value="">What kind of map is this?</option><option value="real">This is a real metro system</option><option value="speculative">This is a real place, but a fantasy map</option><option value="unknown">This is an imaginary place</option></select></form><button id="name-this-map" class="styling-blueline width-100">Name this map</button>');var o=window.sessionStorage.getItem("userGivenMapName"),l=window.sessionStorage.getItem("userGivenMapTags");i&&o&&l&&(a+='<h5><a id="map-somewhere-else">Not a map of '+o+"? Click here to rename</a></h5>"),$("#tool-save-options").html("<fieldset><legend>Save &amp; Share</legend>"+a+"</fieldset>"),i&&o&&$("#user-given-map-name").val(o),i&&l&&$("#user-given-map-tags").val(l),$("#name-map").submit((function(e){e.preventDefault()})),$("#map-somewhere-else").click((function(){$("#name-map").show(),$("#name-this-map").show(),$(this).parent().hide(),$("#name-this-map").removeClass(),$("#name-this-map").addClass("styling-blueline width-100"),$("#name-this-map").text("Name this map")})),$("#name-this-map").click((function(e){$("#user-given-map-name").val($("#user-given-map-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replace("&amp;","&").replaceAll("&","&amp;").replaceAll("/","-").replaceAll("'",""));var t=$("#name-map").serializeArray().reduce((function(e,t){return e[t.name]=t.value,e}),{});window.sessionStorage.setItem("userGivenMapName",$("#user-given-map-name").val()),window.sessionStorage.setItem("userGivenMapTags",$("#user-given-map-tags").val()),csrftoken=getCookie("csrftoken"),t.csrfmiddlewaretoken=csrftoken,$.post("/name/",t,(function(){$("#name-map").hide(),$("#name-this-map").text("Thanks!"),setTimeout((function(){$("#name-this-map").hide()}),500)}))})),i&&o&&l&&($("#user-given-map-name").show(),$("#user-given-map-tags").show(),$("#name-this-map").click(),$("#name-this-map").hide()),$("#tool-save-options").show(),$("#hide-save-share-url").click((function(){$("#tool-save-options").hide()}))}})).fail((function(e){if(400==e.status)var t="Sorry, your map could not be saved. Did you flood fill the whole map? Use flood fill with the eraser to erase and try again.";else if(500==e.status)t="Sorry, your map could not be saved right now. This may be a bug, and the admin has been notified.";else if(e.status>=502)t="Sorry, your map could not be saved right now. Metro Map Maker is currently undergoing routine maintenance including bugfixes and upgrades. Please try again in a few minutes.";$("#tool-save-options").html('<h5 class="text-left bg-warning">'+t+"</h5>"),$("#tool-save-options").show()})).always((function(){setTimeout((function(){$("#tool-save-map span").text("Save & Share")}),350)})),$(".tooltip").hide()})),$("#tool-download-image").click((function(){activeTool="look",downloadImage(combineCanvases()),$(".tooltip").hide()})),$("#tool-export-canvas").click((function(){if(activeTool="look",drawCanvas(activeMap),$("#tool-station-options").hide(),$(".tooltip").hide(),$("#grid-canvas").is(":visible")){$("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide();var e=document.getElementById("metro-map-canvas"),t=document.getElementById("metro-map-stations-canvas");e.getContext("2d",{alpha:!1}).drawImage(t,0,0);var i=e.toDataURL();$("#metro-map-image").attr("src",i),$("#metro-map-image").show(),$("#export-canvas-help").show(),$("button:not(.mobile-browse)").attr("disabled",!0),$(this).attr("disabled",!1),$(this).attr("title","Go back to editing your map").tooltip("fixTitle").tooltip("show")}else $("#grid-canvas").show(),$("#hover-canvas").show(),$("#metro-map-canvas").show(),$("#metro-map-stations-canvas").show(),$("#metro-map-image").hide(),$("#export-canvas-help").hide(),$("button").attr("disabled",!1),$(this).attr("title","Download your map to share with friends").tooltip("fixTitle").tooltip("show")})),$("#tool-clear-map").click((function(){gridRows=80,gridCols=80,(activeMap={global:Object.assign({},activeMap.global),points_by_color:{},stations:{}}).global.map_size=80,snapCanvasToGrid(),drawGrid(),lastStrokeStyle=void 0,drawCanvas(activeMap,!1,!0),drawCanvas(activeMap,!0,!0),window.sessionStorage.removeItem("userGivenMapName"),window.sessionStorage.removeItem("userGivenMapTags"),$(".resize-grid").each((function(){var e=$(this).attr("id").split("-").slice(2),t=e+" x "+e;e==ALLOWED_SIZES[0]&&(t+=" (Current size)"),$(this).html(t)})),showGrid(),$(".tooltip").hide()})),$("#rail-line-new").click((function(){$("#tool-new-line-options").is(":visible")?($(this).children("span").text("Add New Line"),$("#tool-new-line-options").hide()):($(this).children("span").text("Hide Add Line options"),$("#tool-new-line-options").show())})),$("#create-new-rail-line").click((function(){$("#new-rail-line-name").val($("#new-rail-line-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replaceAll("/","-"));var e=[],t=[];for(var i in $(".rail-line").each((function(){e.push($(this).attr("id").slice(10,16)),t.push($(this).text())})),""==$("#new-rail-line-color").val()&&$("#new-rail-line-color").val("#000000"),e.indexOf($("#new-rail-line-color").val().slice(1,7))>=0?$("#tool-new-line-errors").text("This color already exists! Please choose a new color."):t.indexOf($("#new-rail-line-name").val())>=0?$("#tool-new-line-errors").text("This rail line name already exists! Please choose a new name."):0==$("#new-rail-line-name").val().length?$("#tool-new-line-errors").text("This rail line name cannot be blank. Please enter a name."):$("#new-rail-line-name").val().length>100?$("#tool-new-line-errors").text("This rail line name is too long. Please shorten it."):$(".rail-line").length>99?$("#tool-new-line-errors").text("Too many rail lines! Delete your unused ones before creating new ones."):($("#tool-new-line-errors").text(""),$("#line-color-options fieldset").append('<button id="rail-line-'+$("#new-rail-line-color").val().slice(1,7)+'" class="rail-line has-tooltip" style="background-color: '+$("#new-rail-line-color").val()+';">'+$("#new-rail-line-name").val()+"</button>"),activeMap.global||(activeMap.global={lines:{}}),activeMap.global.lines||(activeMap.global.lines={}),$(".rail-line").each((function(){"rail-line-new"!=$(this).attr("id")&&(activeMap.global.lines[$(this).attr("id").slice(10,16)]={displayName:$(this).text()})})),autoSave(activeMap)),bindRailLineEvents(),resetRailLineTooltips(),$("#tool-lines-to-change").html("<option>Edit which rail line?</option>"),activeMap.global.lines)$("#tool-lines-to-change").append('<option value="'+i+'">'+activeMap.global.lines[i].displayName+"</option>")})),$("#rail-line-change").click((function(){for(var e in $("#tool-change-line-options").is(":visible")?($(this).children("span").html("Edit colors &amp; names"),$("#tool-change-line-options").hide()):($(this).children("span").text("Close Edit Line options"),$("#tool-change-line-options").show()),$("#tool-lines-to-change").html("<option>Edit which rail line?</option>"),$("#change-line-name").hide(),$("#change-line-color").hide(),$("#tool-change-line-options label").hide(),$("#tool-change-line-options p").text(""),activeMap.global.lines)$("#tool-lines-to-change").append('<option value="'+e+'">'+activeMap.global.lines[e].displayName+"</option>")})),$("#tool-lines-to-change").on("change",(function(){$("#tool-change-line-options label").show(),"Edit which rail line?"!=$("#tool-lines-to-change option:selected").text()?($("#change-line-name").show(),$("#change-line-color").show(),$("#change-line-name").val($("#tool-lines-to-change option:selected").text()),$("#change-line-color").val("#"+$(this).val())):($("#tool-change-line-options p").text(""),$("#change-line-name").hide(),$("#change-line-color").hide())})),$("#save-rail-line-edits").click((function(){if("Edit which rail line?"!=$("#tool-lines-to-change option:selected").text()){var e=$("#tool-lines-to-change").val(),t=$("#change-line-color").val().slice(1),i=$("#tool-lines-to-change option:selected").text(),a=$("#change-line-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replaceAll("/","-");e!=t&&Object.keys(activeMap.global.lines).indexOf(t)>=0?$("#cant-save-rail-line-edits").text("Can't change "+i+" - it has the same color as "+activeMap.global.lines[t].displayName):(replaceColors({color:e,name:i},{color:t,name:a}),$("#rail-line-change span").html("Edit colors &amp; names"),$("#cant-save-rail-line-edits").text(""),$("#tool-change-line-options").hide(),"line"==activeTool&&(activeTool="look",$("#tool-line").attr("style",""),$("#tool-line").removeClass("active")))}"line"==activeTool&&rgb2hex(activeToolOption).slice(1,7)==e&&(activeToolOption="#"+t),resetRailLineTooltips()})),$("#tool-map-style").on("click",(function(){$("#tool-map-style-options").toggle(),$("#tool-map-style-options").is(":visible")||$("#tool-map-style").removeClass("active"),$(".tooltip").hide(),.75==mapLineWidth?$("#tool-map-style-line-750").addClass("active-mapstyle"):$("#tool-map-style-line-"+1e3*mapLineWidth).addClass("active-mapstyle"),$("#tool-map-style-station-"+mapStationStyle).addClass("active-mapstyle")})),$(".map-style-line").on("click",(function(){mapLineWidth="tool-map-style-line-750"==$(this).attr("id")?.75:1/parseInt($(this).data("line-width-divisor")),$(".map-style-line.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),activeMap&&activeMap.global&&activeMap.global.style?activeMap.global.style.mapLineWidth=mapLineWidth:activeMap&&activeMap.global&&(activeMap.global.style={mapLineWidth:mapLineWidth}),mapDataVersion>=3&&restyleAllLines(mapLineWidth),autoSave(activeMap),drawCanvas()})),$(".map-style-station").on("click",(function(){autoSave(activeMap),mapStationStyle=$(this).data("station-style"),$(".map-style-station.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),$("#reset-all-station-styles").text("Set ALL stations to "+$(this).text()),activeMap&&activeMap.global&&activeMap.global.style?activeMap.global.style.mapStationStyle=mapStationStyle:activeMap&&activeMap.global&&(activeMap.global.style={mapStationStyle:mapStationStyle}),autoSave(activeMap),drawCanvas()})),$("#station-name").change((function(){$(this).val($(this).val().replaceAll('"',"").replaceAll("'","").replaceAll("<","").replaceAll(">","").replaceAll("&","").replaceAll("/","").replaceAll("_"," ").replaceAll("\\\\","").replaceAll("%",""));var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val();Object.keys(temporaryStation).length>0&&(2==mapDataVersion||3==mapDataVersion?(activeMap.stations||(activeMap.stations={}),activeMap.stations[e]||(activeMap.stations[e]={}),activeMap.stations[e][t]=Object.assign({},temporaryStation)):activeMap[e][t].station=Object.assign({},temporaryStation),temporaryStation={}),metroMap=updateMapObject(e,t,"name",$("#station-name").val()),autoSave(metroMap),drawCanvas(metroMap,!0)})),$("#station-name-orientation").change((function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val(),i=parseInt($(this).val());e>=0&&t>=0&&(0==i?Object.keys(temporaryStation).length>0?temporaryStation.orientation=0:2==mapDataVersion||3==mapDataVersion?activeMap.stations[e][t].orientation=0:1==mapDataVersion&&(activeMap[e][t].station.orientation=0):ALLOWED_ORIENTATIONS.indexOf(i)>=0&&(Object.keys(temporaryStation).length>0?temporaryStation.orientation=i:2==mapDataVersion||3==mapDataVersion?activeMap.stations[e][t].orientation=i:1==mapDataVersion&&(activeMap[e][t].station.orientation=i))),window.localStorage.setItem("metroMapStationOrientation",i),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#station-style").on("change",(function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val(),i=$(this).val();e>=0&&t>=0&&(ALLOWED_STYLES.indexOf(i)>=0?Object.keys(temporaryStation).length>0?temporaryStation.style=i:2==mapDataVersion||3==mapDataVersion?activeMap.stations[e][t].style=i:1==mapDataVersion&&(activeMap[e][t].station.style=i):i||(2!=mapDataVersion&&3!=mapDataVersion||!activeMap.stations[e][t].style?1==mapDataVersion&&activeMap[e][t].station.style&&delete activeMap[e][t].station.style:delete activeMap.stations[e][t].style)),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#station-transfer").click((function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val();e>=0&&t>=0&&($(this).is(":checked")?Object.keys(temporaryStation).length>0?temporaryStation.transfer=1:2==mapDataVersion||3==mapDataVersion?activeMap.stations[e][t].transfer=1:1==mapDataVersion&&(activeMap[e][t].station.transfer=1):Object.keys(temporaryStation).length>0?delete temporaryStation.transfer:2==mapDataVersion||3==mapDataVersion?delete activeMap.stations[e][t].transfer:1==mapDataVersion&&delete activeMap[e][t].station.transfer),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#loading").remove()})),$("#set-all-station-name-orientation").on("click",(function(){autoSave(activeMap);var e=$("#set-all-station-name-orientation-choice").val();setAllStationOrientations(activeMap,e),drawCanvas(),setTimeout((function(){$("#set-all-station-name-orientation").removeClass("active")}),500)})),$("#reset-all-station-styles").on("click",(function(){resetAllStationStyles(activeMap),autoSave(activeMap),drawCanvas(),setTimeout((function(){$("#reset-all-station-styles").removeClass("active")}),500)})),$("#try-on-mobile").click((function(){editOnSmallScreen()})),$("#i-am-on-desktop").on("click",(function(){editOnSmallScreen(),$("#tool-export-canvas").remove(),$("#tool-download-image").removeClass("hidden-xs")})),$("#controls-collapse-menu").on("click",collapseToolbox),$("#controls-expand-menu").on("click",expandToolbox),$(".line-style-choice-width").on("click",(function(){$(".line-style-choice-width").removeClass("active"),$(".line-style-choice-width.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),$(this).addClass("active"),activeLineWidth=$(this).attr("data-linewidth")/100,activeLineWidthStyle=activeLineWidth+"-"+activeLineStyle,activeToolOption&&(activeTool="line")})),$(".line-style-choice-style").on("click",(function(){$(".line-style-choice-style").removeClass("active"),$(".line-style-choice-style.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),$(this).addClass("active"),activeLineStyle=$(this).attr("data-linestyle"),activeLineWidthStyle=activeLineWidth+"-"+activeLineStyle,activeToolOption&&(activeTool="line")})),$("#label-text, #label-shape, #label-text-color, #label-bg-color-transparent, #label-bg-color").on("change",(function(){var e=$("#label-coordinates-x").val(),t=$("#label-coordinates-y").val();temporaryLabel.text=$("#label-text").val(),temporaryLabel.shape=$("#label-shape").val(),temporaryLabel["text-color"]=$("#label-text-color").val(),$("#label-bg-color-transparent").is(":checked")?temporaryLabel["bg-color"]=void 0:temporaryLabel["bg-color"]=$("#label-bg-color").val(),autoSave(activeMap=updateMapObject(e,t,!1,Object.assign({},temporaryLabel))),temporaryLabel={},drawCanvas(activeMap,!0),drawLabelIndicator(e,t)})),$("#tool-ruler").on("click",(function(){var e=[3,5,7,!1],t=e.indexOf(rulerStep);rulerStep=-1==t||t==e.length-1?e[0]:e[t+1],window.localStorage.setItem("metroMapRulerStep",rulerStep),drawGrid()})),$("#tool-undo").on("click",undo),$("#tool-redo").on("click",redo);
<!DOCTYPE html>

{% load static metromap_utils %}

<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Make the Metro map of your dreams: create your own metro maps, save them, and share with friends!">

    {% if saved_map and saved_map.name and not saved_map.naming_token %}
    <meta property="og:title" content="{{ saved_map.name }} - Metro Map Maker">
    {% else %}
    <meta property="og:title" content="Metro Map Maker">
    {% endif %}
    <meta property="og:site_name" content="Metro Map Maker">
    <meta property="og:url" content="https://metromapmaker.com{% if saved_map %}/map/{{ saved_map.urlhash }}{% endif %}">
    <meta property="og:type" content="website">
    <meta property="og:description" content="Make the Metro map of your dreams: create your own metro maps, save them, and share with friends!">
    {% if saved_map.png %}
      <meta property="og:image" content="{{ saved_map.png.url }}">
    {% elif saved_map %}
      <meta property="og:image" content="/media/{{ saved_map|get_media_image_url }}">
    {% endif %}
    <meta property="og:image" content="https://metromapmaker.com/static/assets/metromapmaker.png?version=3">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="https://metromapmaker.com">
    <meta name="twitter:title" content="Metro Map Maker">
    <meta name="twitter:description" content="Make the Metro map of your dreams: create your own metro maps, save them, and share with friends!">
    <meta name="twitter:image:src" content="https://metromapmaker.com/static/assets/metromapmaker.png?version=3">
    {% if saved_map.png %}
      <meta name="twitter:image:src" content="{{ saved_map.png.url }}">
    {% elif saved_map %}
      <meta name="twitter:image:src" content="/media/{{ saved_map|get_media_image_url }}">
    {% endif %}

    <title>
      {% if saved_map and saved_map.name %}
        {{ saved_map.name }} ({{ saved_map.urlhash }}) -
      {% elif saved_map %}
        {{ saved_map.urlhash }} -
      {% endif %}
      Metro Map Maker
    </title>

    <link rel="icon" href="{% static 'assets/favicon.ico' %}?version=2">
    <link rel="stylesheet" href="{% static 'css/metromapmaker.css' as mmmcss %}{{ mmmcss }}?version={{ 'css/metromapmaker.css'|static_cache_version }}">

  </head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-24QX9VFLRV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-24QX9VFLRV');
  </script>

<body>

<a name="top"></a>

{% with mmmiconscachetoken='assets/icons/mmm-icons.svg'|static_cache_version %}

<div id="main-container" class="container-fluid">

  <div id="mobile-header" class="visible-xs text-left row">
    <div class="col-lg-10 col-offset-1">
      {# Prevent these turning red for v1; using .mobile instead of .visible-xs because .visible-xs is display:block #}
      <h3><span class="M mobile">M</span>etro <span class="M mobile">M</span>ap <span class="M mobile">M</span>aker</h3>
      <h5>Make the Metro map of your dreams, save, and share with friends!</h5>
      <div id="mobile-browse">
        <fieldset>
          <legend>Browse Maps created by visitors like you</legend>
            <a href="{% url 'public_gallery' %}" class="width-100">
              <button class="styled styling-blueline width-100 mobile-browse">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#postage-heart"/></svg>
                <span class="button-label">My Favorites</span>
              </button>
            </a>
            <a href="{% url 'calendar' %}" class="width-100">
              <button class="styled styling-blueline width-100 mobile-browse">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#calendar-date"/></svg>
                <span class="button-label">All Maps by Date</span>
              </button>
            </a>
            <a href="{% url 'city-list' %}" class="width-100">
              <button class="styled styling-blueline width-100 mobile-browse">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#pin-map"/></svg>
                <span class="button-label">All Maps by City</span>
              </button>
            </a>
          {% if not saved_map %}
            <div id="favorite-maps" class="width-100">
              <p>Some of my favorites include:</p>
              <div class="text-center">
              {% for thumbnail in favorites %}
                <div>
                  <a href="{% url 'home_map' thumbnail.urlhash %}">
                    <img src="{{ thumbnail.thumbnail }}" class="img-responsive center-block" alt="{{ thumbnail.name }}" title="{{ thumbnail.name }}">
                    <h4>{{ thumbnail.name }}</h4>
                  </a>
                </div>
              {% endfor %}
              </div>
            </div> <!-- #favorite-maps -->
          {% endif %}
        </fieldset>
      </div>

      <h5 id="mobile-compatibility-warning" class="visible-xs">This works best on desktop; some features may not work as well if you are on a mobile device.</h5>
      <div style="display: flex;gap: 1rem;margin-bottom: 1rem;">
        <button id="try-on-mobile" class="styled styling-silverline visible-xs">Edit this map anyway</button>
        <button id="i-am-on-desktop" class="styled styling-redline visible-xs">I am on desktop</button>
      </div>
    </div>
  </div>

  <div id="canvas-container" class="col-md-9 col-lg-10" style="width: {{ canvas_size|default:1600 }}px; height: {{ canvas_size|default:1600 }}px;">
    <div id="loading"></div>
    <canvas id='metro-map-canvas' width="{{ canvas_size|default:1600 }}" height="{{ canvas_size|default:1600 }}"></canvas>
    <canvas id='metro-map-stations-canvas' width="{{ canvas_size|default:1600 }}" height="{{ canvas_size|default:1600 }}"></canvas>
    <div id="color-canvas-container"></div>
    <canvas id='grid-canvas' width="{{ canvas_size|default:1600 }}" height="{{ canvas_size|default:1600 }}"></canvas>
    <canvas id="hover-canvas" width="{{ canvas_size|default:1600 }}" height="{{ canvas_size|default:1600 }}"></canvas>
    <canvas id="ruler-canvas" width="{{ canvas_size|default:1600 }}" height="{{ canvas_size|default:1600 }}"></canvas>
    <a id="metro-map-image-download-link" rel="noopener" target="_blank"></a>
    <img id="metro-map-image" class="img-responsive" alt="">
  </div>

  <div id="controls" class="col-md-3 col-lg-2 text-left hidden-xs">
    <h3 id="title"><span class="M">M</span>etro<span class="M">M</span>ap<span class="M">M</span>aker</h3>
    <h3 id="autosave-indicator"></h3>

    <!-- Area where I can put maintenance or similar announcements -->
    <div id="announcement"></div>

    <div id="toolbox">

      <button id="tool-line" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Draw a rail line on the grid (Keyboard shortcut: D)">
          <svg id="tool-line-icon-pencil" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#pencil"/></svg>
          <span id="tool-line-caption-draw" class="button-label"><b><u>D</u></b>raw</span>

          <svg id="tool-line-icon-paint-bucket" width="16" height="16" style="display: none;"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#paint-bucket"/></svg>
          <span id="tool-line-caption-fill" class="button-label" style="display: none;"><b><u>F</u></b>ill</span>
      </button>
      <div id="tool-line-options" style="display: none;">

        <div id="straight-line-assist-options" class="mmm-help-setting">
          <input id="straight-line-assist" type="checkbox" checked="true">
          <label for="straight-line-assist" class="mmm-help-setting has-tooltip" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: G">
            Show guide to help me draw straight lines
          </label>
        </div>
        <div id="flood-fill-options" class="mmm-help-setting">
          <input id="tool-flood-fill" type="checkbox">
          <label for="tool-flood-fill" class="mmm-help-setting has-tooltip" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: F">
            Flood fill instead of draw
          </label>
        </div>

        <div id="line-color-options" class="text-left">
          <fieldset>
            <legend><span class="hide-when-collapsed">Line Color</legend>
          </fieldset>
        </div>

        <div id="line-style-options" class="text-left">
          <fieldset>
            <legend>Line Size <span class="hide-when-collapsed">(Keyboard shortcut: W)</span></legend>
            {% for line_width in ALLOWED_LINE_WIDTHS %}
              <button class="has-hover-preview styled styling-redline line-style-choice-width {% if forloop.first %}active-mapstyle{% endif %}" data-linewidth="{{ line_width }}">
                <span class="style-hover-display"><svg class="bi" width="64" height="48"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#line_width_{{ line_width }}"/></svg></span>
                <span class="style-description">{% if line_width|add:0 == line_width %}{{ line_width|floatformat:0 }}{% else %}{{ line_width }}{% endif %}%</span>
              </button>
            {% endfor %}
          </fieldset>
          <fieldset>
            <legend>Line Style <span class="hide-when-collapsed">(Keyboard shortcut: Q)</span></legend>
            {% for line_style in ALLOWED_LINE_STYLES %}
              <button class="has-hover-preview styled styling-redline line-style-choice-style {% if forloop.first %}active-mapstyle{% endif%}" data-linestyle="{{ line_style }}">
                <span class="style-hover-display"><svg class="bi {% if line_style|is_twotone %}twotone{% endif %}" width="64" height="48"><use id="svgu_ls_{{ line_style }}" xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#line_style_{{ line_style }}"/></svg></span>
                <span class="style-description">{{ line_style|title|underscore_to_space }}</span>
              </button>
            {% endfor %}
          </fieldset>
        </div>

        <button id="rail-line-new" class="styled styling-redline width-100">
          <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#plus-circle"/></svg>
          <span>Add New Color</span>
        </button>
        <div id="tool-new-line-options" class="text-left" style="display: none">
          <fieldset>
            <legend>Add New Color</legend>
            <label for="new-rail-line-color">Color</label>
            <input id="new-rail-line-color" type="color">

            <label for="new-rail-line-name">Name</label>
            <input id="new-rail-line-name" autocomplete="off" type="text" placeholder="Blue Line" maxlength="100">

            <p id="tool-new-line-errors" class="bg-danger"></p>
            <button id="create-new-rail-line" class="styled styling-redline width-100">Save this new color</button>
          </fieldset>
        </div>

        <button id="rail-line-change" class="styled styling-redline width-100">
          <span>Edit colors &amp; names</span>
        </button>
        <div id="tool-change-line-options" class="text-left" style="display: none;">
          <fieldset>
            <legend>Edit Color</legend>
            <select id="tool-lines-to-change">
              <option>Edit which color?</option>
            </select>
            <label for="change-line-color" style="display: none;">Color</label>
            <input id="change-line-color" type="color">
            
            <label for="change-line-name" style="display: none;">Name</label>
            <input id="change-line-name" autocomplete="off" type="text" maxlength="100">
            <p id="cant-save-rail-line-edits" class="bg-danger"></p>
            <button id="save-rail-line-edits" class="styled styling-redline width-100">Save edits to this color</button>
          </fieldset>
        </div>
        <button id="rail-line-delete" class="styled styling-silverline width-100">
          <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#trash"/></svg>
          <span class="button-label">Delete Unused Colors</span>
        </button>
      </div>

      <button id="tool-station" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Create a station on an existing rail line, or edit an existing station (Keyboard shortcut: S)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#pin-map"/></svg>
        <span class="button-label"><b><u>S</u></b>tation</span>
      </button>
      <div id="tool-station-options" class="text-left" style="display: none;">
        <fieldset>
          <legend>Add / Edit <span class="hide-when-collapsed">Station</span></legend>
          <input id="station-coordinates-x" type="hidden">
          <input id="station-coordinates-y" type="hidden">

          <label for="station-name"><span class="hide-when-collapsed">Station</span> Name</label>
          <input id="station-name" autocomplete="off" type="text" placeholder="Silver Spring" maxlength="255">

          <div style="width: 100%;">
            <input id="station-transfer" type="checkbox">
            <label for="station-transfer">Transfer <span class="hide-when-collapsed">Station</span></label>
          </div>

          <label for="station-name-orientation"><span class="hide-when-collapsed">Station Name</span> Orientation</label>
          <select id="station-name-orientation">
            <option value="0">On the right</option>
            <option value="180">On the left</option>
            <option value="-45">Above-right, 45&deg;</option>
            <option value="45">Below-right, 45&deg;</option>
            <option value="-135">Above-left, 45&deg;</option>
            <option value="135">Below-left, 45&deg;</option>
            <option value="90">Above, 90&deg;</option>
            <option value="-90">Below, 90&deg;</option>
            <option value="1">Above</option>
            <option value="-1">Below</option>
          </select>

          <label for="station-style">Style</label>
          <select id="station-style">
            <option value="">(Use Default)</option>
            {% for station_style, station_style_names in ALLOWED_STATION_STYLES.items %}
                <option value="{{ station_style }}">{{ station_style_names.long }}</option>
            {% endfor %}
          </select>

          <button id="move-station" class="has-tooltip styled styling-redline width-100 mt-3" data-toggle="tooltip" data-placement="left" title="Allows you to place a station somewhere else on the map. (You must place a station on a drawn line, and it can't be placed on another station.) You can also use the arrow keys to move a station while the station menu is open, even if Move Station is off. (Keyboard shortcut: M)">
            <span class="button-label"><b><u>M</u></b>ove station<span id="move-station-enabled">: Arrow Keys only</span></span>
          </button>
        </fieldset>
      </div>

      <button id="tool-eraser" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Erase a drawn rail line or station (Keyboard shortcut: E)">
        <svg id="tool-eraser-icon-eraser" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#eraser"/></svg>
        <span id="tool-eraser-caption-eraser" class="button-label"><b><u>E</u></b>rase</span>

        <svg id="tool-eraser-icon-paint-bucket" width="16" height="16" style="display: none;"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#paint-bucket"/></svg>
        <span id="tool-eraser-caption-fill" class="button-label" style="font-size: 80%; display: none;">Eraser Fill</span>
      </button>

      <button id="tool-map-style" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Change Style of Lines and Stations (Keyboard shortcut: Y)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#palette"/></svg>
        <span class="button-label">St<b><u>y</u></b>le</span>
      </button>

      {% comment %}

        REDUCE THE SCOPE OF v7.0 BY PUNTING LABELS TO LATER,
          SO YOU HAVE MORE TIME TO GET THEM RIGHT

      <button id="tool-label" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Add a label anywhere on the map (Keyboard shortcut: L)">
        <svg id="tool-label-icon-tags" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#tags"/></svg>
        <span class="button-label"><b><u>L</u></b>abel</span>
      </button>
      <div id="tool-label-options" class="text-left" style="display: none;">
        <fieldset>
          <legend>Add / Edit Label</legend>

          <input id="label-coordinates-x" type="hidden">
          <input id="label-coordinates-y" type="hidden">

          <label for="label-text">Text</label>
          <input id="label-text" autocomplete="off" name="label-text" type="text" placeholder="Red" maxlength="255">

          <label for="label-shape">Shape</label>
          <select id="label-shape" name="label-shape">
              TODO : Refactor to use the ALLOWED_* for this and other label options
            <option value="rect">Rectangle</option>
            <option value="rect-round">Rounded Rectangle</option>
            <option value="circle">Circle</option>
            <option value="square">Square</option>
          </select>

          <label for="label-text-color">Text Color</label>
          <select id="label-text-color" name="label-text-color">
            <option value="#ffffff">White</option>
            <option value="#000000">Black</option>
            <option value="#333333">Dark Grey</option>
          </select>

          <label for="label-bg-color-transparent">Transparent Background</label>
          <input type="checkbox" id="label-bg-color-transparent" name="label-bg-color-transparent">

          <label for="label-bg-color">Background Color</label>
          <input id="label-bg-color" type="color">
        </fieldset>
      </div>

      {% endcomment %}

      <div id="tool-map-style-options" class="text-left" style="display: none;">
          <fieldset>
            <legend>Map Line Size</legend>
            <h5>Change the line width for ALL lines at once.</h5>
            {# TODO: Refactor this to use ALLOWED_LINE_WIDTHS #}
            <button id="tool-map-style-line-1000" class="map-style-line styled styling-redline width-100" data-line-width-divisor="1">100%</button>
            <button id="tool-map-style-line-750" class="map-style-line styled styling-redline width-100" data-line-width-divisor="">75%</button>
            <button id="tool-map-style-line-500" class="map-style-line styled styling-redline width-100" data-line-width-divisor="2">50%</button>
            <button id="tool-map-style-line-250" class="map-style-line styled styling-redline width-100" data-line-width-divisor="4">25%</button>
            <button id="tool-map-style-line-125" class="map-style-line styled styling-redline width-100" data-line-width-divisor="8">12.5%</button>
          </fieldset>
          <fieldset>
            <legend>Station Shape</legend>
            <h5>Change the shape of all stations that don't have a specific shape.</h5>

            <!-- I like the look of these buttons not having width-100 better,
                  though it looks a little awkward when there's an odd number of options.
            -->

            {% for station_style, station_style_names in ALLOWED_STATION_STYLES.items %}
                <button id="tool-map-style-station-{{ station_style }}" class="has-hover-preview map-style-station styled styling-redline" data-station-style="{{ station_style }}">
                  <span class="style-hover-display"><svg class="bi" width="64" height="48"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#style-{{ station_style }}"/></svg></span>
                  <span class="style-description">{{ station_style_names.short }}</span>
                </button>
            {% endfor %}

            <button id="reset-all-station-styles" class="styled styling-redline width-100">Reset to default</button>
          </fieldset>
          <fieldset>
            <legend>Station Orientations</legend>
            <h5 style="width: 100%;">Changes label orientation for ALL stations at once.</h5>
            <label for="set-all-station-name-orientation-choice">Orientation</label>
            <select id="set-all-station-name-orientation-choice">
              <option value="0">On the right</option>
              <option value="180">On the left</option>
              <option value="-45">Above-right, 45&deg;</option>
              <option value="45">Below-right, 45&deg;</option>
              <option value="-135">Above-left, 45&deg;</option>
              <option value="135">Below-left, 45&deg;</option>
              <option value="90">Above, 90&deg;</option>
              <option value="-90">Below, 90&deg;</option>
              <option value="1">Above</option>
              <option value="-1">Below</option>
            </select>
            <button id="set-all-station-name-orientation" class="styled styling-redline width-100">Set orientations</button>
          </fieldset>
      </div>

      <button id="tool-move-all" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Recenter your Metro map (Keyboard shortcuts: Arrow keys)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrows-move"/></svg>
        <span class="button-label" style="font-size: 75%">Move map</span>
      </button>
      <div id="tool-move-options" class="text-left" style="display: none;">
        <fieldset>
          <legend>Move Map</legend>
          <h5 id="tool-move-v1-warning" style="display: none;">Be careful! If you move your map out of bounds, you'll lose your work. (In the next version of Metro Map Maker, you'll be prevented from going out of bounds.)</h5> <!-- "In the next version" is a bit of a misnomer, but hard to communicate which data model you're on since I'm trying hard to keep everything backwards-compatible -->
          <button id="tool-move-up" class="has-tooltip styled styling-redline width-100" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: Up arrow">
            <span><svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-up-circle"/></svg> Move everything up</span>
          </button>
          <button id="tool-move-left" class="has-tooltip styled styling-redline width-100" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: Left arrow">
            <span><svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-left-circle"/></svg> Move everything left</span>
          </button>
          <button id="tool-move-right" class="has-tooltip styled styling-redline width-100" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: Right arrow">
            <span><svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-right-circle"/></svg> Move everything right</span>
          </button>
          <button id="tool-move-down" class="has-tooltip styled styling-redline width-100" data-toggle="tooltip" data-placement="left" title="Keyboard shortcut: Down arrow">
            <span><svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-down-circle"/></svg> Move everything down</span>
          </button>
        </fieldset>
      </div>

      <button id="tool-resize-all" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Resize the grid, allowing you to make larger maps">
        <svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrows-angle-expand"/></svg>
        <span class="button-label">Resize</span>
      </button>
      <div id="tool-resize-options" class="text-left" style="display: none;">
        <fieldset>
          <legend>Resize Map</legend>
          <h5>Be careful! If your map is large and you resize it to be smaller, you'll lose your work.</h5>
          {% for allowed_size in ALLOWED_MAP_SIZES %}
            <button id="tool-resize-{{ allowed_size }}" class="resize-grid styled styling-redline">
              {{ allowed_size }}x{{ allowed_size }}
            </button>
          {% endfor %}
          <button id="tool-resize-stretch" class="has-tooltip stretch-grid styled styling-redline" data-toggle="tooltip" data-placement="left" title="Increase the available space between stations so you can add more stations in between.">Stretch Map</button>
        </fieldset>
      </div>

      <button id="tool-undo" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Undo a recent change to the map. (Keyboard shortcut: Control + Z, or Command + Z on Mac)">
        <svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#undo"/></svg>
        <span class="button-label">Undo <span id="undo-buffer-count"></span></span>
      </button>
      <button id="tool-redo" class="has-tooltip styled styling-redline" data-toggle="tooltip" data-placement="left" title="Redo a recent change you just undid. (Keyboard shortcut: Control + Y, or Command + Y on Mac)">
        <svg class="bi" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#redo"/></svg>
        <span class="button-label">Redo <span id="redo-buffer-count"></span></span>
      </button>

      <button id="tool-download-image" class="width-100 has-tooltip hidden-xs styled styling-blueline" data-toggle="tooltip" data-placement="left" title="Download your map to share with friends">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#file-image"/></svg>
        <span class="button-label">Download {% if saved_map.svg %}(PNG){% endif %}</span>
      </button>

      {% if saved_map.svg %}
        <a href="{{ saved_map.svg.url }}" download="{{ saved_map.urlhash }}.svg" style="width: 100%;"><button id="tool-download-svg" class="width-100 has-tooltip styled styling-blueline" data-toggle="tooltip" data-placement="left" title="Download the map '{{ saved_map.urlhash }}' as a print-quality SVG file (does not include your edits, if any)">
          <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#file-image"/></svg>
          <span class="button-label">Download (SVG)</span>
        </button></a>
      {% endif %}

      <!-- Download button when on mobile -->
      <button id="tool-export-canvas" class="width-100 has-tooltip visible-xs styled styling-blueline" data-toggle="tooltip" data-placement="left" title="Download your map to share with friends">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#file-image"/></svg>
        <span class="button-label">Download</span>
      </button>

      <div id="export-canvas-help" class="text-left" style="display: none;">
        <fieldset>
          <h5><b>On mobile, downloading maps works differently. Tap and hold the map to save as an image, or right click the map and click "Save Image As".</b></h5>
          <h5>Click the "Download" button again to go back to editing your map.</h5>
          <h5>Happy with your map? Be sure to click Save &amp; Share map and it might be <a href="https://metromapmaker.com/gallery" rel="noopener" target="_blank">featured in the gallery</a>!</h5>
        </fieldset>
      </div>

      <button id="tool-save-map" class="width-100 has-tooltip styled styling-blueline" data-toggle="tooltip" data-placement="left" title="Save your map and create a unique, shareable URL for it.">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#save"/></svg>
        <span class="button-label">Save &amp; Share</span>
      </button>
      <div id="tool-save-options" class="text-left hide-when-collapsed" style="display: none;"></div>

      <button id="tool-grid" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Adjust how many squares are visually grouped together on the grid, to make it easier to evenly space lines and stations. (Keyboard shortcut: H)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#grid"/></svg>
        <span class="button-label">
          S<b><u>h</u></b>ow Grid: <span id="grid-step">5</span>
        </span>
      </button>

      <button id="tool-ruler" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="When on, shows distance between two points. Always shows x,y coordinates in the button as you move the cursor. Tip: You can use the ruler in combination with the Draw, Erase, and Station tools. (Keyboard shortcut: R)">
        <div id="ruler-icon-xy-container">
          <svg class="" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#ruler"/></svg>
        </div>
        <span>
            <span class="hide-when-collapsed"><b><u>R</u></b>uler: </span>
            <span id="ruler-xy"></span>
        </span>
      </button>

      <button id="tool-eyedropper" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="When on, clicking a point on the map will switch to the Draw tool and use that point's color, line width, and line style. (Keyboard shortcut: P)">
        <div id="ruler-icon-xy-container">
          <svg class="" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#eyedropper"/></svg>
        </div>
        <span class="button-label">
            Eyedro<b><u>p</u></b>per
        </span>
      </button>

      <button id="tool-look" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="When on and used with the Ruler tool, the ruler will update as you move the mouse, not just when you click. (Keyboard shortcut: K)">
        <div id="ruler-icon-xy-container">
          <svg class="" width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#look"/></svg>
        </div>
        <span class="button-label">
            Loo<b><u>k</u></b>
        </span>
      </button>

      <button id="tool-zoom-in" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Zoom in. Keyboard shortcut: +">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#zoom-in"/></svg>
        <span class="button-label">Zoom <b>+</b></span>
      </button>
      <button id="tool-zoom-out" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Zoom out. Keyboard shortcut: -">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#zoom-out"/></svg>
        <span class="button-label">Zoom <b>-</b></span>
      </button>

      <button id="snap-controls-left" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Move all controls to the left side of the screen (Keyboard shortcut: [)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-left-circle"/></svg>
        <span class="button-label" style="font-size: 80%;">Move controls</span>
      </button>
      <button id="snap-controls-right" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Move all controls to the right side of the screen (Keyboard shortcut: ])" style="display: none;">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrow-right-circle"/></svg>
        <span class="button-label" style="font-size: 80%;">Move controls</span>
      </button>

      <button id="controls-collapse-menu" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Collapse menu and only show icons. Only the most commonly-used controls and options are shown when collapsed. (Keyboard shortcut: C)">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrows-collapse-vertical"/></svg>
        <span class="button-label"><b><u>C</b></u>ollapse</span>
      </button>

      <button id="controls-expand-menu" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Expand Menu (Keyboard shortcut: C)" style="display: none;">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#arrows-expand-vertical"/></svg>
      </button>

      {% comment %}
      Hide for now, consider revisiting later
      <button id="controls-dock-menu" class="has-tooltip styled styling-greenline" data-toggle="tooltip" data-placement="left" title="Move controls to top, right, bottom, or left of screen">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#window-desktop"/></svg>
        <span class="button-label">Dock</span> <!-- TODO: this should replace "snap controls to left" and cycle between top,right,bottom,left (clockwise) -->
      </button>
      {% endcomment %}

      <button id="tool-clear-map" class="has-tooltip styled styling-silverline width-100" data-toggle="tooltip" data-placement="left" title="Be careful: this will delete your map">
        <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#trash"/></svg>
        <span class="button-label">Clear map</span>
      </button>

    </div> <!-- #toolbox -->

      <div id="remix">
        <fieldset>
          <legend>Browse & Remix</legend>
            <a href="{% url 'public_gallery' %}" class="width-100">
              <button class="has-tooltip styled styling-blueline width-100" data-toggle="tooltip" data-placement="left" title="These are some of my favorite maps made by visitors like you">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#postage-heart"/></svg>
                <span class="button-label">My Favorites</span>
              </button>
            </a>
            <a href="{% url 'calendar' %}" class="width-100">
              <button class="has-tooltip styled styling-blueline width-100" data-toggle="tooltip" data-placement="left" title="All Metro Maps ever made by visitors like you">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#calendar-date"/></svg>
                <span class="button-label">All Maps by Date</span>
              </button>
            </a>
            <a href="{% url 'city-list' %}" class="width-100">
              <button class="has-tooltip styled styling-blueline width-100" data-toggle="tooltip" data-placement="left" title="All Metro Maps ever made by vistors like you, grouped by their city">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#pin-map"/></svg>
                <span class="button-label">All Maps by City</span>
              </button>
            </a>
            {% if saved_map %}
              <a href="{% url 'calendar-day' saved_map.created_at.year saved_map.created_at.month saved_map.created_at.day %}" class="width-100">
                <button class="has-tooltip styled styling-blueline width-100" data-toggle="tooltip" data-placement="left" title="Browse maps made on the same date as this map">
                  <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#calendar-date"/></svg>
                  <span class="button-label">{{ saved_map.created_at.date }}</span>
                </button>
              </a>
            {% else %}
              <a href="{% url 'calendar-day' today.year today.month today.day %}" class="width-100">
                <button class="has-tooltip styled styling-blueline width-100" data-toggle="tooltip" data-placement="left" title="Browse maps made today">
                  <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#calendar-date"/></svg>
                  <span class="button-label">Maps made today</span>
                </button>
              </a>
            {% endif %}
            <a href="{% url 'help' %}" class="width-100">
              <button class="has-tooltip styled styling-greenline width-100" data-toggle="tooltip" data-placement="left" title="New to Metro Map Maker? Get help on how to get started">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#life-preserver"/></svg>
                <span class="button-label">Help</span>
              </button>
            </a>
            <a href="https://blog.metromapmaker.com/" class="width-100">
              <button class="has-tooltip styled styling-greenline width-100" data-toggle="tooltip" data-placement="left" title="Metro Map Maker blog: Behind the scenes">
                <svg width="16" height="16"><use xlink:href="{% static 'assets/icons/mmm-icons.svg' %}?version={{ mmmiconscachetoken }}#newspaper"/></svg>
                <span class="button-label">Blog / News</span>
              </button>
            </a>
        </fieldset>
      </div>

      <div id="credits">
        <h5>Created by <a href="{% url 'credits' %}">Shannon Turner</a></h5>
        <h6>By using MetroMapMaker, you place maps you make in the <a href="https://en.wikipedia.org/wiki/Public_domain" rel="noopener" target="_blank">public domain</a>.</h6>
      </div>

  </div> <!-- #controls -->

</div> <!-- #main-container -->

{% endwith %}{# mmmiconscachetoken #}

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  {% if saved_map %}

    {% if saved_map.data %}
      {{ saved_map.data|json_script:"mapdata_v2" }}
      <script type="text/javascript">
        var savedMapData =  document.getElementById('mapdata_v2').textContent
        savedMapData = JSON.parse(savedMapData)
        var mapDataVersion = 2
      </script>
    {% elif saved_map.mapdata %}
      {{ saved_map.mapdata|json_script:"mapdata_v1" }}
      <script type="text/javascript">
        // So nice we have to JSON.parse() twice :-/
        var savedMapData =  document.getElementById('mapdata_v1').textContent
        savedMapData = JSON.parse(JSON.parse(savedMapData))
        var mapDataVersion = 1
      </script>
    {% endif %}

    {% if saved_map_name %}
      {{ saved_map_name|json_script:"saved_map_name" }}
      <script type="text/javascript">
        var userGivenMapName = document.getElementById('saved_map_name').textContent
        window.sessionStorage.setItem('userGivenMapName', JSON.parse(userGivenMapName))
      </script>
    {% endif %}

  {% elif 'Map was not found.' in error %} {# Not saved map but error means there's no map for this urlhash. #}
    <script type="text/javascript">
      var autoLoadError = 'Map was not found. '
    </script>
  {% elif error %}
    <script type="text/javascript">
      var autoLoadError = 'Cannot load this map. '
    </script>
  {% endif %}

  <!--
    For a human-readable version of the Javascript, see https://metromapmaker.com{% static "js/metromapmaker.js" %}
  -->
  {% if debug %}
    <script src='{% static "js/metromapmaker.js" as mmmjs %}{{ mmmjs }}?version={{ "js/metromapmaker.js"|static_cache_version }}' async></script>
  {% else %}
    <script src='{% static "js/metromapmaker.min.js" %}{{ mmmjs }}?version={{ "js/metromapmaker.min.js"|static_cache_version }}' async></script>
  {% endif %}
  <script src='{% static "js/tooltips.min.js" %}' defer="defer"></script>
  <script src='{% static "js/django-csrf.js" %}' defer="defer"></script>
  <script src='{% static "js/mmm-cheatcodes.js" %}' defer="defer"></script>

  <script type="text/javascript">
    // Announcements
    var announcementStorage = 'announcement-2024-11-30' // UPDATE THIS WHEN CHANGING THE MESSAGE
    var announcementMessage = '<h4 id="announce-whats-new" style="text-align: left;">Version 7.1 adds <a href="https://blog.metromapmaker.com/">so many new features</a>! If you <a href="https://blog.metromapmaker.com/">sign up for free email updates</a> you can be the first to know about new releases,'
    // ----- ^^^ ----- EDITABLE PORTION ----- ^^^ -----
    announcementMessage += ' or <span id="close-' + announcementStorage + '" class="close-announcement" style="text-decoration: underline; cursor: pointer;">close this message</span>.</h4>'
    var announcement = parseInt(window.localStorage.getItem(announcementStorage) || 0)
    if (announcement <= 1) {
      // They've seen it 0-2 times, show it until they've clicked hide twice
      $('#announcement').append(announcementMessage)
    }
    $('body').on('click', '#close-' + announcementStorage, function() {
      $('#announce-whats-new').remove()
      window.localStorage.setItem(announcementStorage, announcement + 1)
    })
    // Evergreen How to use MMM message
    var howToMMMCount = parseInt(window.localStorage.getItem('how-to-mmm-count') || 0)
    if (howToMMMCount < 1) {
      // How to make maps: only show until they've clicked hide once
      $('#announcement').append('<h4 id="announce-how-to" style="text-align: left;"><a href="{% url "help" %}">[Video] How to make maps with Metro Map Maker</a> <span id="close-how-to-mmm" class="close-announcement" style="text-decoration: underline; cursor: pointer;">Close this message</span>')
    }
    $('body').on('click', '#close-how-to-mmm', function() {
      $('#announce-how-to').remove()
      window.localStorage.setItem('how-to-mmm-count', howToMMMCount + 1)
    })
  </script>

  </body>
</html>